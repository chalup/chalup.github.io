
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Porcupine Programmer</title>
  <meta name="author" content="Jerzy Chalupski">

  
  <meta name="description" content="When your Fragment puts some actions in the action bar, it should call setHasOptionsMenu(true). And where should you make this call? You probably &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://chalup.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Porcupine Programmer" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-51611487-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Porcupine Programmer</a></h1>
  
  <h2>Programming rants, random stuff and some more programming<a href="elmtype/index.html">.</a></h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:chalup.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/28/sethasoptionsmenu-gotcha/">setHasOptionsMenu Gotcha</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-28T23:31:57+02:00" pubdate data-updated="true">Sep 28<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/09/28/sethasoptionsmenu-gotcha/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2014/09/28/sethasoptionsmenu-gotcha/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When your <code>Fragment</code> puts some actions in the action bar, it should call <code>setHasOptionsMenu(true)</code>. And where should you make this call? You probably follow samples and call it from <code>onCreate()</code> callback.</p>

<p>Later you decide to hide one of the actions under certain circumstances. The way do to this is to implement <code>onPrepareOptionsMenu(Menu)</code> callback and alter the <code>Menu</code> object passed as an argument.</p>

<p>If you are not careful, depending on the visibility precondition you apply, you might have implemented instant crash on OS versions before Jelly Bean. On API level 17, the <code>onPrepareOptionsMenu</code> is called from runnable posted on some handler; on older versions the menu callbacks are called synchronously, so they are really called from <code>onCreate()</code>, which means that your Fragment is not yet fully initialized.</p>

<p>What&rsquo;s the takeaway? Always test your app on wide variety of devices and OSes before the release, do not trust official Android samples, and call <code>setHasOptionsMenu(true)</code> at the end of <code>onActivityCreated()</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/26/preparing-for-android-l-fixing-sqlite-queries/">Preparing for Android L - Fixing SQLite Queries</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-26T19:13:21+02:00" pubdate data-updated="true">Sep 26<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/09/26/preparing-for-android-l-fixing-sqlite-queries/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2014/09/26/preparing-for-android-l-fixing-sqlite-queries/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today during the routine check of Android crash reports, I saw that one of the custom SQLite queries fails with <code>ambiguous column: id</code> message. There were two interesting aspects of this issue: nobody touched this part of code for a while; and there were only handful of crashes from a single device, and when you have a botched query it should crash left, right and center.</p>

<p>Fortunately a while back we decided to log the sqlite version available on a given device, so I had the crucial piece of information that let me find the root cause in no time. This particular device used custom ROM with Sqlite 3.8.x installed, which caught my eye, because the standard version used by Android 4.x is 3.7.11.</p>

<p>Here&rsquo;s the <a href="http://sscce.org/">short, self contained, correct example</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">x</span> <span class="p">(</span><span class="n">id</span> <span class="nb">INTEGER</span><span class="p">);</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">y</span> <span class="p">(</span><span class="n">id</span> <span class="nb">INTEGER</span><span class="p">,</span> <span class="n">x_id</span> <span class="nb">INTEGER</span><span class="p">);</span>
</span><span class='line'><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">x</span> <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">y</span> <span class="k">ON</span> <span class="n">x</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">y</span><span class="p">.</span><span class="n">x_id</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">id</span>
</span></code></pre></td></tr></table></div></figure>


<p>SQLite 3.7.11 assumes the user wants to group the rows by <code>x.id</code>, 3.8 fails with <code>ambiguous column: id</code> error, which is more sensible thing to do. The fix is trivial:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">x</span> <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">y</span> <span class="k">ON</span> <span class="n">x</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">y</span><span class="p">.</span><span class="n">x_id</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">x</span><span class="p">.</span><span class="n">id</span>
</span></code></pre></td></tr></table></div></figure>


<p>What&rsquo;s really important about this gotcha is that sqlite 3.8 will be the default version used by Android L, rumored to be released on November 1st. You might say that you don&rsquo;t have any custom queries in your app, but you&rsquo;d have to consider every dependency performing any data persistence you use. The best course of action is to test your application thoroughly on device with L preview image or emulator.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/14/contentprovider-series-uris/">ContentProvider Series - Uris</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-14T21:19:18+02:00" pubdate data-updated="true">Sep 14<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/09/14/contentprovider-series-uris/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2014/09/14/contentprovider-series-uris/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The <code>ContentResolver</code> and <code>SQLiteDatabase</code> APIs are very similar:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public Cursor query (Uri uri,      String[] projection, String selection, String[] selectionArgs,                                String sortOrder            )
</span><span class='line'>public Cursor query (String table, String[] columns,    String selection, String[] selectionArgs, String groupBy, String having, String orderBy, String limit)</span></code></pre></td></tr></table></div></figure>


<p>Some arguments are renamed, SQL-specific <code>groupBy</code>+<code>having</code> are omitted, and <code>limit</code> also got an axe, but it is pretty much the same, except for the first argument.</p>

<h2>Content Uris 101</h2>

<p>Instead of specifying database table, you have to pass the <code>Uri</code> describing the resource you want to access. By convention the Uri should have <code>content</code> scheme (use <a href="http://developer.android.com/reference/android/content/ContentResolver.html#SCHEME_CONTENT">SCHEME_CONTENT</a> constant), followed by the <code>ContentProvider</code> authority, and the path, which is mapped to resources.</p>

<p>If you have ever accessed any REST-ish API, or built the routes table for the web app, you&rsquo;ll find it familiar. Querying <code>/foo</code> should return the list of <code>foo</code>s, <code>/foo/1</code> operates on <code>foo</code> with id <code>1</code> and <code>/foo/1/bar</code> refers to all <code>bar</code>s related to <code>foo</code> with id <code>1</code>. The last <code>Uri</code> pattern is not mentioned in <a href="http://developer.android.com/guide/topics/providers/content-provider-creating.html#ContentURI">API Guides</a>, but is widely used in <a href="https://github.com/google/iosched">Google I/O Schedule app</a> and system <code>ContentProvider</code>s.</p>

<h2>Publish &ndash; subscribe</h2>

<p>The <code>Uri</code> parameter leaks from <code>ContentProvider</code> API into <code>Cursor</code>. You can call <code>Cursor.setNotificationUri()</code> to specify that the <code>Cursor</code> will observe changes on the given <code>Uri</code> and propagate the notification to all <code>ContentObserver</code>s registered with <code>Cursor.registerContentObserver()</code>. So when someone calls <code>ContentResolver.notifyChange()</code> on the same Uri, these <code>ContentObserver</code>s will be notified of the change. This is the mechanism that powers the automatic reloading of <code>CursorLoader</code>s.</p>

<p>But what about the related Uris? Shouldn&rsquo;t observers of <code>/foo</code> Uri be notified when the <code>/foo/1</code> is updated? In case of standard <code>Cursors</code> that&rsquo;s exactly what happens, because the observers registered in <code>AbstractCursor</code> base class use <code>true</code> as <code>notifyForDescendents</code> parameter. But if your specific use case requires observing only single specific Uri, you can call <code>contentResolver.registerContentObserver(uri, false, observer)</code>.</p>

<h2>Semantics</h2>

<p>Content Uri semantics for querying content, i.e. how the Uri path affects the query, were already described in &ldquo;Content Uris 101&rdquo; section above. Semantics for other actions are not explicitly specified anywhere in the Android documentation, but again I/O Schedule app and system <code>ContentPovider</code>s implement it in a common way that can be thought of as standard to be followed.</p>

<p>For deletes and updates the Uri path are treated the same ways as for queries &ndash; as additional selection.</p>

<p>For inserts, the Uri path is translated to additional <code>ContentValues</code> that should be inserted into database, e.g. insert on <code>/foo/42/bar</code> create new <code>bar</code> record with supplied <code>ContentValues</code> and with <code>foo_id</code> (or similar foreign key field) set to 42.</p>

<h2>Issue #1 &ndash; many to many</h2>

<p>The described mechanics work well for one-to-many relations, but there is a problem with entities in many-to-many relations. Let&rsquo;s use <code>sessions</code> and <code>tags</code> from Google I/O Schedule app as an example. Each session can be tagged with mutliple tags, and many sessions can be tagged with the same tag.</p>

<p>The semantics of querying <code>/sessions/*/tags</code> or <code>/tags/*/sessions</code> are OK. The first one should return all tags of a given session and the second one should yield the list of sessions tagged with a given tag. But on which Uri should you insert a new link between existing tag and existing session?</p>

<p>Usually many-to-many relationships are modeled with linking table, in this case &ldquo;sessions_tags&rdquo;. But you cannot really pass the related tag and session in Uri path: <code>/sessions/*/tags/*/sessions_tags</code> or similar Uris look weird. One option is to put it directly in ContentValues, but this means that this entities will be created in a different way than all the other entities in one-to-many relations. Another option is use query parameters, i.e. insert on <code>/sessions_tags?relatedTo=/tags/*&amp;relatedTo=/sessions/*</code> Uri, which is ugly, but explicit.</p>

<h2>Issue #2 &ndash; subscription vs. joins</h2>

<p>Let&rsquo;s go back to querying the <code>/sessions/*/tags</code> endpoint. Under the hood we&rsquo;d join <code>tags</code> table with <code>sessions_tags</code> table, but most likely we&rsquo;d set the <code>Cursor</code>&rsquo;s notification Uri to <code>/sessions/*/tags</code>. It means that our Cursor won&rsquo;t be notified of changes on <code>/tags</code>, <code>/sessions_tags</code> and descendant Uris, although it might affect the data we queried.</p>

<p>The only solution offered by Android SDK is calling <code>notifyChange</code> on insert, delete and update with multiple Uris, but there are two issues with this approach: you might end up notifying half of your endpoints for every small change, forcing way to many content reloads; it&rsquo;s error prone, because changing one endpoint might require manual changes of many different endpoints.</p>

<p>What you really need for such cases are multiple notification Uris on Cursor, alas, that&rsquo;s not possible with regular Cursors implementations.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/10/contentprovider-series-introduction/">ContentProvider Series - Introduction</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-10T21:25:19+02:00" pubdate data-updated="true">Sep 10<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/09/10/contentprovider-series-introduction/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2014/09/10/contentprovider-series-introduction/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the first section of Android <a href="http://developer.android.com/guide/index.html">API Guides</a> is the description of different app compontents. New developers can read about Activities, which map directly to app UI, about Services, which perform background tasks, about BroadcastReceivers, which let&rsquo;s your app react to different system events, etc. At some point they read about ContentProvider and they think:</p>

<blockquote><p>Why would I want to use it?</p></blockquote>


<p>Android documentation give two reasons: when you want to share data with other applications; or when you want to integrate with search framework. I&rsquo;d say these use cases do not apply to most of the Android applications out there, but there are other resasons for using ContentProviders.</p>

<h2>Database handle management</h2>

<p>Let&rsquo;s say you don&rsquo;t use ContentProvider, but you want to use the SQLite database to store your data. Most likely you&rsquo;ll end up with the <code>SQLiteOpenHelper</code> singleton in your <code>Application</code> object with some helper methods. Easy to code, but it&rsquo;s really reimplementation of <code>Context.getContentResolver()</code>.</p>

<h2>Encapsulation</h2>

<p>If you go with the solution described above, you&rsquo;ll operate directly on the <code>SQLiteOpenHelper</code> or <code>SQLiteDatabase</code> objects and if you&rsquo;re not careful, this implementation detail will leak across your application. Ideally you should create an abstraction around it, but then you&rsquo;ll end up with something like ContentProvider anyways.</p>

<h2>When in Rome, do as the Romans do</h2>

<p>The ContentProvider API is leaked throughout the Android SDK. Whether it&rsquo;s good or bad thing is a topic for another blog post, but the facts stay the same. If you decide not to use the ContentProvider, you forego publish-subscribe mechanism provided by <code>CursorLoaders</code> (<strong>tl;dr:</strong> you can set up automatic reload of data on the UI when the data is updated), <code>SyncAdapter</code> framework with built-in throttling, etc. You can implement all of this on your own, but you probably should focus on your business logic and UX instead of rewriting Android SDK.</p>

<h2>IPC</h2>

<p>As in &ldquo;Inter-process communication&rdquo;. I haven&rsquo;t seen this point raised in any ContentProvider discussions, but the ContentProvider can be moved to separate process (if you don&rsquo;t do some smelly things like accessing singletons) or accessed from any other processes in your application. And why would you want to do this?</p>

<p>If you don&rsquo;t do some brain-dead stupid things, the biggest source of animation jank in your application is garbage collection pauses. This problem is partially solved by GC improvements in ART in Android L, but let&rsquo;s face it &ndash; I don&rsquo;t expect will be <code>minSdkVersion=20</code> before the end of 2016. Until then we need another solution.</p>

<p>Since GC is performed per-process, one thing you can do is moving your memory intensive operations &ndash; like web API access and JSON parsing &ndash; to another process. But if you want to access your database from another process you can&rsquo;t use <code>SQLiteOpenHelper</code> singleton. You&rsquo;ll have to access it through some IPC mechanism. ContentProvider gives you this for free.</p>

<h2>Summary</h2>

<p>There are more to ContentProviders than you can see in the official documentation or top 5 hits on Google search. Actually, this is the first post in the upcoming series of posts in which I&rsquo;ll describe some other aspects of ContentProvider implementation like content Uris design, thread safety, ContentProvider API deficiencies, documentation samples suckage and some solutions that can make implementing ContentProviders less painful. Stay tuned!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/04/my-shortest-lived-project-ever/">My Shortest-lived Project Ever</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-04T21:11:06+02:00" pubdate data-updated="true">Sep 4<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/09/04/my-shortest-lived-project-ever/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2014/09/04/my-shortest-lived-project-ever/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Three weeks ago I wrote a <a href="https://github.com/chalup/proguard-please">proguard-please</a> plugin. I was super excited by this project because:</p>

<ol>
<li>It was a Gradle plugin, something I wanted to play with for quite some time</li>
<li>It was written in Groovy, a language I wanted to play with for quite some time</li>
<li>It solved a real issue with ProGuard configuration, which was pissing me off for quite some time</li>
</ol>


<h2>On configuring ProGuard</h2>

<p>If you&rsquo;re not familiar with ProGuard, here&rsquo;s the basic info: it&rsquo;s a program which prunes the unused code from your compiled Java program. It can also do other stuff like optimization or code obfuscation and repackaging to make the reverse engineering harder. Sounds good? The catch is that ProGuard sometimes cuts out or obfuscates too much code, which usually breaks the app, especially if you rely on reflection. The trick is to configure it correctly for each library you use, but it&rsquo;s not a trivial task.</p>

<p>The general idea for this plugin was to resolve the dependencies of your Android application and try to find the ProGuard configuration for every one of them. Of course the ProGuard config will not magically appear: the idea was to have a repository of configurations developed by the community.</p>

<h2>On Gradle</h2>

<p>First part of the project went really smooth, thanks to the <a href="http://www.gradle.org/docs/current/userguide/userguide.html">amazing documentation</a>. I didn&rsquo;t need to do any fancy stuff, so I was able to configure the basic scaffolding in no time at all. Docs for android gradle plugin are pretty much non-existent, but using the imported sources and <a href="https://bitbucket.org/hvisser/android-apt">android-apt</a> plugin by <a href="https://twitter.com/botteaap">Hugo Visser</a> as a base for Android related tasks I was able to get my plugin up and running.</p>

<h2>On Groovy</h2>

<p>I saw the Groovy for the first time at KrakDroid conference, when <a href="https://github.com/wojtekerbetowski">Wojciech Erbetowski</a> converted boring JUnit tests into <a href="https://github.com/Polidea/RoboSpock">RoboSpock</a> goodness. It looked nice, but when I started coding in Groovy, my love for this language faded.</p>

<p>There are lot of things I take for granted as a Java developer: amazing IDE, instant feedback when I screw something up and documentation for the code under my cursor at my fingertips. Maybe switching to Groovy, Ruby or Python requires some mindset change I haven&rsquo;t fully embraced, but I simply cannot imagine why would I switch to the language that effectively forces me to write my code in Notepad™.</p>

<p>I think the main problem I have with Groovy stems for the fact that there are some APIs that wouldn&rsquo;t typecheck in regular Java. Consider this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="k">if</span> <span class="o">(!</span><span class="n">project</span><span class="o">.</span><span class="na">android</span><span class="o">[</span><span class="s2">&quot;productFlavors&quot;</span><span class="o">].</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ProjectConfigurationException</span><span class="o">(</span><span class="s2">&quot;The build flavors are not supported yet&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">def</span> <span class="n">obfuscatedVariants</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="na">android</span><span class="o">[</span><span class="s2">&quot;applicationVariants&quot;</span><span class="o">].</span><span class="na">findAll</span> <span class="o">{</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">v</span><span class="o">.</span><span class="na">obfuscation</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s a classic type of what I call &ldquo;string typing&rdquo;: depending on the key used in <code>project.android[]</code> access you get collection of objects of completely different type. As a consequence, the IDE cannot provide you with autocompletion or documentation for the collection contents.</p>

<p>Another example is the public API of Grgit library. Theoretically you can call <code>Grgit.clone(...)</code>, but there is no such method as <code>clone</code> in <code>Grgit</code> class, instead you have this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Grgit</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Map</span> <span class="n">STATIC_OPERATIONS</span> <span class="o">=</span> <span class="o">[</span><span class="nl">init:</span> <span class="n">InitOp</span><span class="o">,</span> <span class="nl">clone:</span> <span class="n">CloneOp</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">static</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Grgit</span><span class="o">.</span><span class="na">metaClass</span><span class="o">.</span><span class="na">static</span><span class="o">.</span><span class="na">methodMissing</span> <span class="o">=</span> <span class="o">{</span> <span class="n">name</span><span class="o">,</span> <span class="n">args</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="n">OpSyntaxUtil</span><span class="o">.</span><span class="na">tryOp</span><span class="o">(</span><span class="n">Grgit</span><span class="o">,</span> <span class="n">STATIC_OPERATIONS</span><span class="o">,</span> <span class="o">[]</span> <span class="k">as</span> <span class="n">Object</span><span class="o">[],</span> <span class="n">name</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>  
</span></code></pre></td></tr></table></div></figure>


<p>I don&rsquo;t see what&rsquo;s wrong with the good ol&#8217; static method and what do you achieve by using <code>methodMissing</code> (besides confusing the IDE and breaking autocomplete/javadocs). Maybe I&rsquo;m just grupy old fart with brain eroded by too long exposure to Java, but Groovy is definitely not a language for me. I&rsquo;ll put up with it if I ever want to write another gradle plugin, but it&rsquo;s not going to be my go to language.</p>

<h2>What&rsquo;s up with the blog title?</h2>

<p>Few hours after publishing my project, another solution for ProGuard configuration appeared. It turns out, if you use gradle to build your library, you can configure <code>consumerProguardFiles</code> property to include in your aar package a ProGuard configuration that should be used by the users of your library. The logical next step is creating the library project containing only the ProGuard configuration for the most popular libraries out there. And that&rsquo;s exactly what <a href="https://bitbucket.org/littlerobots/squadleader">squadleader</a> project is.</p>

<p>It&rsquo;s not as flexible solution as my <a href="https://github.com/chalup/proguard-please">proguard-please</a> plugin, but it&rsquo;s much simpler, much easier to contribute to and the net effect is the same. In this light I chose to put my project on hold and redirect developers to squadleader page.</p>

<p>Despite of that, I&rsquo;m glad I worked on this project. I&rsquo;m very excited by the fact that you can easily build an useful tool that&rsquo;s incredibly easy to use. Using gradle for a new build system was a great call.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/03/android-recent-apps-list-and-intent-extras/">Android Recent Apps List and Intent Extras</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-03T22:14:06+02:00" pubdate data-updated="true">Jul 3<span>rd</span>, 2014</time>
        
           | <a href="/blog/2014/07/03/android-recent-apps-list-and-intent-extras/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2014/07/03/android-recent-apps-list-and-intent-extras/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you&rsquo;re programming for the same platform for some time, you have probably developed some habits. You do some stuff in a particular way, because you&rsquo;ve always done it this way. It might be a good thing if you know all pros and cons of your solution, because your code will be consistent and you don&rsquo;t waste time rethinking the same things over and over again. On the other hand it is a good practice to question this established ways of doing things from time to time &ndash; maybe you&rsquo;ve missed something when you thought about this last time or some of your arguments are no longer valid.</p>

<p>For me one of such things was the <code>Serializable</code> vs. <code>Parcelable</code> conundrum. A long time ago I read somewhere that <code>Serializable</code> is much slower than <code>Parcelable</code> and it shouldn&rsquo;t be used for large objects, but it&rsquo;s fast enough for passing simple POJOs between <code>Fragments</code> and <code>Activities</code> with <code>Intent</code> or arguments <code>Bundle</code>. While this is still a generally good advice, I realized I don&rsquo;t know how much faster the <code>Parcelable</code> is. Are we looking at 10µs vs. 15µs or 10µs vs. 10ms?</p>

<p>I&rsquo;m too lazy to write a benchmark myself, but I found a <a href="http://www.developerphil.com/parcelable-vs-serializable/">decent article</a>. Tl;dr: on modern hardware (Nexus 4) serializing a simple data structure takes about 2ms and using <code>Parcelable</code> is about 10 times faster.</p>

<p>Another hit on Google was a <a href="http://www.reddit.com/r/androiddev/comments/1daiib/parcelable_vs_serializable/">reddit thread</a> for this article. I found there an interesting comment by <a href="https://plus.google.com/u/1/+JakeWharton">+Jake Wharton</a>:</p>

<blockquote><p>Serializable is like a tattoo. You are committing to a class name, package, and field structure forever. The only way to &#8220;remove&#8221; it is epic deserialization hacks.</p><p>Yes using it in an Intent isn&#8217;t much harm, but if you use serialization there&#8217;s a potential for crashing your app. They upgrade, hit your icon on the launcher, and Android tries to restore the previous Intent for where they were at in your app. You changed the object so deserialization fails and the app crashes. Not a good upgrade experience. Granted this is rare, but if you ever persist something to disk like this it can leave you in an extremely bad place.</p></blockquote>


<p>There are two inaccuracies in the comment above. First, the problem will happen only if the app is started from the recet apps list, not from the launcher icon. Second, the problem is not limited to <code>Serializable</code> extras: <code>Parcelable</code> might read the byte stream originally written from a different structure (in this situation crash is a best case scenario), some extras might be missing, some might hold wrong type of data.</p>

<p>Can you prevent this issue? I don&rsquo;t think so, at least not without some sophisticated validation of Intent extras. Considering that this issue is very rare and it goes away after starting the faulty app from somewhere else than recent apps list I don&rsquo;t think you should spend any time trying to fix it, but it&rsquo;s good to know about it, as it might explain some WTF crash reports coming your way.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/27/google-i-slash-o-2014-summary/">Google I/O 2014 Summary</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-27T21:34:11+02:00" pubdate data-updated="true">Jun 27<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/06/27/google-i-slash-o-2014-summary/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2014/06/27/google-i-slash-o-2014-summary/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here are my thoughts after watching the keynote and few Android related sessions.</p>

<h2>Highlights</h2>

<h3>Android One</h3>

<p>This might be a huge, not only because it means expanding the potential user base for your apps. The most important thing is that all these new devices will run the latest Android and software updates will be provided by Google. If this kind of support becomes standard, we might be able to use <code>minSdkVersion=20</code> pretty soon.</p>

<h3>ART</h3>

<p>The Dalvik was decomissioned, the new runtime is the only runtime. I do hope this means that the 64k method limit is no longer a problem and there are no technical roadblocks for Java 8 support. Maybe this questions were answersed during <a href="https://www.google.com/events/io/schedule/session/b750c8da-aebe-e311-b297-00155d5066d7">The ART runtime</a> session, unfortunately there was no live stream of it.</p>

<p><strong>Edit</strong>: the video from the session is available. The GC improvements and performance boosts are amazing, but if I understand everything correctly the ART still uses dex bytecode underneath, so all Dalvik limitations are still in place.   Bad Google.</p>

<h3><a href="https://plus.google.com/+XavierDucrohet/posts">+Xavier Ducrohet</a></h3>

<p>I got the feeling that he&rsquo;s the only Google employee who acknowledges that there are serious issues with developing on Android. Great answers about unit tests and robolectric support, good answer about Scala support.</p>

<h2>Dunno what to make of it</h2>

<h3>RecyclerView</h3>

<p><code>ListViews</code> are far from perfect. I know, because in our codebase we have few workarounds for the issues or poor APIs. It&rsquo;s good that something more flexible is available, it&rsquo;s great that it&rsquo;s a part of support library, but some parts of the <code>RecyclerView</code> API look incredibly complex.</p>

<h3>Unlock bypass with Wear device</h3>

<p>Call me paranoid, but this feature means that if I get mugged, I&rsquo;m totally screwed. Someone gets access to my email, and through that he gets access to every piece of my data on the web and my digital idendity. Thanks, I&rsquo;ll pass.</p>

<p>On the other hand there are users who do not use pin or pattern on the lockscreens. For these people, this feature is a significant security improvement.</p>

<h2>Lowlights</h2>

<h3>Always running, big-ass TVs</h3>

<p>During keynote one speaker mentioned that in average household the TV is on for 5 hours every day and suggested that for the other 19 hours it can be used as a digital canvas for your content. I&rsquo;m not sure if encouraging people to keep the huge, power hungry device all the time to display nice pictures is very thoughtful and enviromentally aware.</p>

<h3>Fireside chat</h3>

<p>There were some über lame questions from the audience, but that&rsquo;s expected when questions are not moderated. However there were also über lame answers for valid questions, and there is no excuse for it.</p>

<p>The very first question, about Java 8 support, was answered with smirks and a slimy answer from Chet Haase. Dear Google, after WWDC the Java 8 support is no longer a huge news, so if you&rsquo;re saving it for the future, don&rsquo;t bother. And if there are any issues with Java 8 support &ndash; legal, technical, whatever &ndash; just let the developers know.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/20/on-git-ui/">On Git</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-20T13:40:12+02:00" pubdate data-updated="true">Jun 20<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/06/20/on-git-ui/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2014/06/20/on-git-ui/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As madeupstatistics.com report, 95% posts about git can be divided into three types:</p>

<ol>
<li><p>Whining about rebases, because &ldquo;git history is a bunch of lies&rdquo;.</p>

<p>   Right, because everyone needs to see your &ldquo;fixed typo&rdquo; mistakes and early API design blunders.</p></li>
<li><p>Whining about rebases, because you should document the &ldquo;roads not taken&rdquo;, not obliterate them.</p>

<p> This argument is actually pretty good, but from my experience these not taken roads, dead ends and detours do not tell the full story either. VCS is not the right tool for this.</p></li>
<li><p>Whining about crappy CLI command names.</p>

<p> It&rsquo;s hard to defend some choices, but here&rsquo;s the thing: you need to memorize maybe a dozen commands and in return you get the most powerful VCS tool you can get today. So toughen up princess, stop whining and learn them.</p></li>
</ol>


<p>So today I was pleasantly surprised when I found today actually a <a href="http://tonsky.me/blog/reinventing-git-interface/">good blog post about git UI</a>. Go ahead and read it. While I do not agree with everything OP wrote, he got two things right: git model and <code>git log --graph</code> improvements.</p>

<p><img class="center" src="http://tonsky.me/blog/reinventing-git-interface/overview@2x.png"></p>

<h2>Git Mental Model</h2>

<p>People do not need to know that there are blobs, sha checksum calculated from whatnot and so one. What I say to every git newcomer is this: <strong>commits are connected with parent commits, and branches, tags, HEAD, etc. are all just pointers to commits</strong>. Then you just need to figure out that <code>git commit</code> doesn&rsquo;t do any magic, it just adds commit and moves HEAD and current branch pointers.</p>

<h2>Commits Graph Representation</h2>

<p>Every git workflow description contain a beautiful, clear diagram explaining where commits are added and merged &ndash; <a href="http://nvie.com/posts/a-successful-git-branching-model/">this is a good example</a>. Then you start using this workflow and after two weeks your <code>git log --graph --all</code> output looks like a failed knitting experiment. The difference is that the diagrams keep the commits from a single branch aligned in a column, and <code>git log</code> tries to reduce the space taken by graph, which mixes multiple branches in a single column.</p>

<p>I&rsquo;m not sure if it&rsquo;s doable with current git data model though &ndash; the commits do not contain any information about the branch. I think the branch name could be derived from the current branches and merge commits messages, but I&rsquo;m sure it won&rsquo;t work for 100% of cases. For these edge cases it would be great to allow users to manually select the correct branch, but this means the branch information would have to be kept outside of commits, but inside git. Tricky stuff.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/15/minsdkversion-equals-15/">minSdkVersion=15, What&#8217;s Next?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-15T09:29:50+02:00" pubdate data-updated="true">Jun 15<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/06/15/minsdkversion-equals-15/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2014/06/15/minsdkversion-equals-15/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A year ago <a href="https://twitter.com/readyState">Jeff Gilfelt</a> was giving away <code>minSdkVersion=14</code> stickers, promoting the idea of dumping the support for Gingerbread and Honeycomb. What seemed radical one year ago, today is a widely accepted. The <code>minSdkVersion</code> in new project wizard in latest Android Studio release is by default set to <code>15</code>. On the same screen you can click the &ldquo;help me choose&rdquo; hyperlink, which shows this screen:</p>

<p><img class="center" src="/images/android_studio_min_sdk.png"></p>

<p>The percentages are consistent with data from <a href="http://developer.android.com/about/dashboards/index.html">developer.android.com</a> dashboards, but I&rsquo;d say they are skewed towards old Android versions. <a href="https://play.google.com/store/apps/details?id=com.futuresimple.base">Base CRM</a> app I&rsquo;m working on has only 3.7% active users on devices with api level &lt; 15 (compared to 17.4% from official Google dashboards). Moreover, if you look only at the new users, the Froyo, GingerBread and Honeycomb is used only by 1%. In this light, supporting pre-API15 devices is a criminal waste, and starting new projects with minSdkVersion lower than 15 a criminal idiocy.</p>

<p>For me, as a delevoper, the <code>minSdkVersion=14</code> is a breakthrough, mostly because of Holo theme available everywhere. I no longer have to worry about <a href="http://localhost:4000/blog/2012/03/08/customizing-ui-controls-on-android/">HTC rounded green buttons and such when creating custom views</a> &ndash; I only have to make them look good with a single theme. Theoretically one could have used <a href="https://github.com/Prototik/HoloEverywhere">HoloEverywhere lib</a>, but it&rsquo;s not a drop-in replacement. First you have to switch to using their Views instead of native ones and adjusting any external UI library to use them as well.</p>

<p>I looked through the <a href="https://developer.android.com/about/index.html">Android changelogs</a> wondering what could be the next version on <code>minSdkVersion</code> stickers. The next step is a small bump to JellyBean (API level 16), which gives us access to actions in system notifications and <code>condensed</code> and <code>light</code> Roboto font variants. Official statictics state that Ice Cream Sandwich is used by 12.3% of users, but this number is much higher than the one from Base statistics &ndash; 5.87%. I expect dropping support for ICS this year.</p>

<p>But then? I don&rsquo;t see anything as groundbreaking as dropping Gingerbread. I don&rsquo;t even see anything with more impact than dropping ICS. Theoretically API level 17 gives access to nested fragments, but I think you should be using support-v4 classes anyways (and if you check the <a href="https://play.google.com/store/apps/details?id=com.google.samples.apps.iosched">Google I/O 2014</a> app sources, Google developers seem to think so too). Maybe there&rsquo;s something I missed or something crucial for specific use cases &ndash; do let me know if there&rsquo;s anything in API levels 17-19 you wish you could use already.</p>

<p>Google I/O is coming though, and <a href="https://twitter.com/GabMarioPower/status/477040313832583168">some things indicate</a> we might see Android 5.0 (or at least Android 4.5). Maybe this Android &ldquo;L&rdquo; version will be another breakthrough in development? My personal wish is a new runtime without <a href="https://code.google.com/p/android/issues/detail?id=20814">ridiculous 64k method limit</a>. Of course this opens a lot of other possibilities. Maybe support for Java 8? Or first-class support for other JVM languages? We&rsquo;ll see&hellip;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/13/beatiful-code-comparisonchain-from-guava/">Beatiful Code: ComparisonChain</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-13T20:28:24+02:00" pubdate data-updated="true">Jun 13<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/06/13/beatiful-code-comparisonchain-from-guava/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2014/06/13/beatiful-code-comparisonchain-from-guava/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I usually tend to write about certain <a href="/blog/categories/gotcha">gotchas</a> and weird <a href="/blog/categories/android/">Android issues</a>, so if you expect yet another rant, I have a surprise for you &ndash; today, I&rsquo;m going to write about a piece of code I&rsquo;m very fond of.</p>

<p>As you might have noticed, <a href="/blog/categories/guava">I&rsquo;m a big fan of Guava</a>. One of the classes I extensively use is <a href="http://docs.guava-libraries.googlecode.com/git-history/release/javadoc/com/google/common/collect/ComparisonChain.html"><code>ComparisonChain</code></a>, which lets you turn this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="n">Person</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">lastName</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">lastName</span><span class="o">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">cmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">cmp</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="n">cmp</span> <span class="o">=</span> <span class="n">firstName</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">firstName</span><span class="o">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">cmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">cmp</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">Integer</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">zipCode</span><span class="o">,</span> <span class="n">other</span><span class="o">.</span><span class="na">zipCode</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Into this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="n">Person</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">ComparisonChain</span><span class="o">.</span><span class="na">start</span><span class="o">()</span>
</span><span class='line'>      <span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">lastName</span><span class="o">,</span> <span class="n">other</span><span class="o">.</span><span class="na">lastName</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">firstName</span><span class="o">,</span> <span class="n">other</span><span class="o">.</span><span class="na">firstName</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">zipCode</span><span class="o">,</span> <span class="n">other</span><span class="o">.</span><span class="na">zipCode</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="na">result</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When I first saw this API I was a bit worried about performance, because this code is supposed to be used in <code>Comparator</code>s, which are executed multiple times during <code>Collection</code> sorting, and it looks like it could allocate a lot of objects. So I looked at the <a href="https://code.google.com/p/guava-libraries/source/browse/guava/src/com/google/common/collect/ComparisonChain.java">source code</a> and I was enlightened.</p>

<p>ComparisonChain is an abstract class with few versions of <code>compare</code> method returning ComparisonChain object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">ComparisonChain</span> <span class="nf">compare</span><span class="o">(</span><span class="n">Comparable</span><span class="o">&lt;?&gt;</span> <span class="n">left</span><span class="o">,</span> <span class="n">Comparable</span><span class="o">&lt;?&gt;</span> <span class="n">right</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">abstract</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">ComparisonChain</span> <span class="n">compare</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">T</span> <span class="n">left</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">T</span> <span class="n">right</span><span class="o">,</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">comparator</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">ComparisonChain</span> <span class="nf">compare</span><span class="o">(</span><span class="kt">int</span> <span class="n">left</span><span class="o">,</span> <span class="kt">int</span> <span class="n">right</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">ComparisonChain</span> <span class="nf">compare</span><span class="o">(</span><span class="kt">long</span> <span class="n">left</span><span class="o">,</span> <span class="kt">long</span> <span class="n">right</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">ComparisonChain</span> <span class="nf">compare</span><span class="o">(</span><span class="kt">float</span> <span class="n">left</span><span class="o">,</span> <span class="kt">float</span> <span class="n">right</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">ComparisonChain</span> <span class="nf">compare</span><span class="o">(</span><span class="kt">double</span> <span class="n">left</span><span class="o">,</span> <span class="kt">double</span> <span class="n">right</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">ComparisonChain</span> <span class="nf">compareTrueFirst</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">left</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">right</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">ComparisonChain</span> <span class="nf">compareFalseFirst</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">left</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">right</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>To get the result of comparison you call another abstract method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">result</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>The trick is, there are only two implementations and three instances of ComparisonChain: anonymous <code>ACTIVE</code>, and <code>LESS</code> and <code>GREATER</code> instances of InactiveComparisonChain.</p>

<p><code>ACTIVE</code> instance is the one you get from <code>ComparisonChain.start()</code> call. Various <code>compare</code> methods in <code>ACTIVE</code> instance perform comparison on supplied arguments, and depending on result return <code>ACTIVE</code>, <code>LESS</code> or <code>GREATER</code> object. Calling <code>result</code> on <code>ACTIVE</code> ComparisonChain yields 0.</p>

<p>InactiveComparisonChain&rsquo;s instances &ndash; <code>LESS</code> and <code>GREATER</code> &ndash; do not perform any comparisons and return themselves &ndash; if you got this object, it means that earlier comparison already established the result. The role of this object is just to forward <code>result</code> call to appropriate instance. <code>LESS.result()</code> returns -1 and <code>GREATER.result()</code> +1.</p>

<p>The whole class is elegant, provide beautiful API for a common task and the implementation is very efficient. The world needs more code like this.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/09/28/sethasoptionsmenu-gotcha/">setHasOptionsMenu Gotcha</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/26/preparing-for-android-l-fixing-sqlite-queries/">Preparing for Android L - Fixing SQLite Queries</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/14/contentprovider-series-uris/">ContentProvider Series - Uris</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/10/contentprovider-series-introduction/">ContentProvider Series - Introduction</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/04/my-shortest-lived-project-ever/">My Shortest-lived Project Ever</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/chalup">@chalup</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'chalup',
            count: 0,
            skip_forks: true,
            filter_repos: [ "microorm", "thneed", "dawggenerator", "cerberus" ],
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/106340839330487061995?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Jerzy Chalupski -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'porcupineprogrammer';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
