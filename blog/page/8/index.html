
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Porcupine Programmer</title>
  <meta name="author" content="Jerzy Chalupski">

  
  <meta name="description" content="I&rsquo;ve received an email from &ldquo;Nu, Pogodi!&rdquo; customer, saying that he cannot download my game from Nokia Store after updating his N8 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://chalup.github.io/blog/page/8">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Porcupine Programmer" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-51611487-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Porcupine Programmer</a></h1>
  
    <h2>Programming rants, random stuff and some more programming.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:chalup.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/23/nokia-belle-update-and-content/">Nokia Belle Update and Content Published in Nokia Store</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-23T16:22:00+01:00" pubdate data-updated="true">Feb 23<span>rd</span>, 2012</time>
        
           | <a href="/blog/2012/02/23/nokia-belle-update-and-content/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/02/23/nokia-belle-update-and-content/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve received an email from &ldquo;Nu, Pogodi!&rdquo; customer, saying that he cannot <a href="http://store.ovi.com/content/219800">download my game from Nokia Store</a> after updating his N8 phone firmware to Symbian Belle. After quick investigation in turned out that the N8 Belle device was listed as &ldquo;Not compatible&rdquo; in content distribution details.</p>

<p>When I published my game in November, the only devices running with Belle firmware were Nokia 603, 700 and 701. When the Belle update for various phones was released, the new firmwares were added to the list as &ldquo;Not compatible&rdquo;, because that&rsquo;s the only reasonable default. It&rsquo;s prudent to prevent users from downloading application that might not work, because it&rsquo;s very likely that in case of any errors they&rsquo;ll post a negative review, and it&rsquo;s very hard to bump your rating from 1 or 2 stars average. I verified that everything works fine and updated the distribution metadata.</p>

<p>So here&rsquo;s the piece of advice for anyone who published some content in Nokia Store: periodically check if there are new firmwares available and update your content distribution.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/22/android-layoutinflater-gotcha/">Android LayoutInflater Gotcha</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-22T09:26:00+01:00" pubdate data-updated="true">Feb 22<span>nd</span>, 2012</time>
        
           | <a href="/blog/2012/02/22/android-layoutinflater-gotcha/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/02/22/android-layoutinflater-gotcha/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Many custom Adapter tutorials contain subtle error which can be hard to find and fix. Even <a href="http://developer.android.com/resources/samples/ApiDemos/src/com/example/android/apis/view/List14.html">efficient list adapter sample from Android SDK</a> contains this bug. If you compile and run the sample without any changes you should see something like this:</p>

<p><img class="center" src="/images/original.png"></p>

<p>There&rsquo;s nothing wrong with the list on this screenshot, as long as that&rsquo;s the look you want. But what if you want the list items to be wider? Let&rsquo;s change the list item layout:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class='line'><span class="c">&lt;!-- Copyright (C) 2007 The Android Open Source Project</span>
</span><span class='line'>
</span><span class='line'><span class="c">     Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
</span><span class='line'><span class="c">     you may not use this file except in compliance with the License.</span>
</span><span class='line'><span class="c">     You may obtain a copy of the License at</span>
</span><span class='line'><span class="c">  </span>
</span><span class='line'><span class="c">          http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span class='line'><span class="c">  </span>
</span><span class='line'><span class="c">     Unless required by applicable law or agreed to in writing, software</span>
</span><span class='line'><span class="c">     distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
</span><span class='line'><span class="c">     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span><span class='line'><span class="c">     See the License for the specific language governing permissions and</span>
</span><span class='line'><span class="c">     limitations under the License.</span>
</span><span class='line'><span class="c">--&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
</span><span class='line'>    <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span>
</span><span class='line'>    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
</span><span class='line'>    <span class="na">android:layout_height=</span><span class="s">&quot;150dip&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;ImageView</span> <span class="na">android:id=</span><span class="s">&quot;@+id/icon&quot;</span>
</span><span class='line'>        <span class="na">android:layout_width=</span><span class="s">&quot;48dip&quot;</span>
</span><span class='line'>        <span class="na">android:layout_height=</span><span class="s">&quot;48dip&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;TextView</span> <span class="na">android:id=</span><span class="s">&quot;@+id/text&quot;</span>
</span><span class='line'>        <span class="na">android:layout_gravity=</span><span class="s">&quot;center_vertical&quot;</span>
</span><span class='line'>        <span class="na">android:layout_width=</span><span class="s">&quot;0dip&quot;</span>
</span><span class='line'>        <span class="na">android:layout_weight=</span><span class="s">&quot;1.0&quot;</span>
</span><span class='line'>        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/LinearLayout&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>What&rsquo;s changed? Nothing, nada, zilch, zip. No changes whatsoever:</p>

<p><img class="center" src="/images/changed.png"></p>

<p>You can use hierarchy viewer tool to verify that the list item height was not set correctly.</p>

<p><img class="center" src="/images/hierarchy.png"></p>

<p>There&rsquo;s obviously nothing wrong with the layout xml, so let&rsquo;s take a look at the code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Copyright (C) 2008 The Android Open Source Project</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
</span><span class='line'><span class="cm"> * you may not use this file except in compliance with the License.</span>
</span><span class='line'><span class="cm"> * You may obtain a copy of the License at</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *      http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Unless required by applicable law or agreed to in writing, software</span>
</span><span class='line'><span class="cm"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
</span><span class='line'><span class="cm"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span><span class='line'><span class="cm"> * See the License for the specific language governing permissions and</span>
</span><span class='line'><span class="cm"> * limitations under the License.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">apis</span><span class="o">.</span><span class="na">view</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.app.ListActivity</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.view.LayoutInflater</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.view.ViewGroup</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.widget.BaseAdapter</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.widget.ImageView</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.graphics.BitmapFactory</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.graphics.Bitmap</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.example.android.apis.R</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Demonstrates how to write an efficient list adapter. The adapter used in this example binds</span>
</span><span class='line'><span class="cm"> * to an ImageView and to a TextView for each row in the list.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * To work efficiently the adapter implemented here uses two techniques:</span>
</span><span class='line'><span class="cm"> * - It reuses the convertView passed to getView() to avoid inflating View when it is not necessary</span>
</span><span class='line'><span class="cm"> * - It uses the ViewHolder pattern to avoid calling findViewById() when it is not necessary</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * The ViewHolder pattern consists in storing a data structure in the tag of the view returned by</span>
</span><span class='line'><span class="cm"> * getView(). This data structures contains references to the views we want to bind data to, thus</span>
</span><span class='line'><span class="cm"> * avoiding calls to findViewById() every time getView() is invoked.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">List14</span> <span class="kd">extends</span> <span class="n">ListActivity</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">EfficientAdapter</span> <span class="kd">extends</span> <span class="n">BaseAdapter</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">private</span> <span class="n">LayoutInflater</span> <span class="n">mInflater</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">private</span> <span class="n">Bitmap</span> <span class="n">mIcon1</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">private</span> <span class="n">Bitmap</span> <span class="n">mIcon2</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="nf">EfficientAdapter</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// Cache the LayoutInflate to avoid asking for a new one each time.</span>
</span><span class='line'>            <span class="n">mInflater</span> <span class="o">=</span> <span class="n">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Icons bound to the rows.</span>
</span><span class='line'>            <span class="n">mIcon1</span> <span class="o">=</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeResource</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">(),</span> <span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">icon48x48_1</span><span class="o">);</span>
</span><span class='line'>            <span class="n">mIcon2</span> <span class="o">=</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeResource</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">(),</span> <span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">icon48x48_2</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/**</span>
</span><span class='line'><span class="cm">         * The number of items in the list is determined by the number of speeches</span>
</span><span class='line'><span class="cm">         * in our array.</span>
</span><span class='line'><span class="cm">         *</span>
</span><span class='line'><span class="cm">         * @see android.widget.ListAdapter#getCount()</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCount</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">DATA</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/**</span>
</span><span class='line'><span class="cm">         * Since the data comes from an array, just returning the index is</span>
</span><span class='line'><span class="cm">         * sufficent to get at the data. If we were using a more complex data</span>
</span><span class='line'><span class="cm">         * structure, we would return whatever object represents one row in the</span>
</span><span class='line'><span class="cm">         * list.</span>
</span><span class='line'><span class="cm">         *</span>
</span><span class='line'><span class="cm">         * @see android.widget.ListAdapter#getItem(int)</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getItem</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">position</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/**</span>
</span><span class='line'><span class="cm">         * Use the array index as a unique id.</span>
</span><span class='line'><span class="cm">         *</span>
</span><span class='line'><span class="cm">         * @see android.widget.ListAdapter#getItemId(int)</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getItemId</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">position</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/**</span>
</span><span class='line'><span class="cm">         * Make a view to hold each row.</span>
</span><span class='line'><span class="cm">         *</span>
</span><span class='line'><span class="cm">         * @see android.widget.ListAdapter#getView(int, android.view.View,</span>
</span><span class='line'><span class="cm">         *      android.view.ViewGroup)</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="kd">public</span> <span class="n">View</span> <span class="nf">getView</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="n">View</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// A ViewHolder keeps references to children views to avoid unneccessary calls</span>
</span><span class='line'>            <span class="c1">// to findViewById() on each row.</span>
</span><span class='line'>            <span class="n">ViewHolder</span> <span class="n">holder</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// When convertView is not null, we can reuse it directly, there is no need</span>
</span><span class='line'>            <span class="c1">// to reinflate it. We only inflate a new View when the convertView supplied</span>
</span><span class='line'>            <span class="c1">// by ListView is null.</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">convertView</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">convertView</span> <span class="o">=</span> <span class="n">mInflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">list_item_icon_text</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// Creates a ViewHolder and store references to the two children views</span>
</span><span class='line'>                <span class="c1">// we want to bind data to.</span>
</span><span class='line'>                <span class="n">holder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ViewHolder</span><span class="o">();</span>
</span><span class='line'>                <span class="n">holder</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">text</span><span class="o">);</span>
</span><span class='line'>                <span class="n">holder</span><span class="o">.</span><span class="na">icon</span> <span class="o">=</span> <span class="o">(</span><span class="n">ImageView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">icon</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">convertView</span><span class="o">.</span><span class="na">setTag</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// Get the ViewHolder back to get fast access to the TextView</span>
</span><span class='line'>                <span class="c1">// and the ImageView.</span>
</span><span class='line'>                <span class="n">holder</span> <span class="o">=</span> <span class="o">(</span><span class="n">ViewHolder</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">getTag</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Bind the data efficiently with the holder.</span>
</span><span class='line'>            <span class="n">holder</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">DATA</span><span class="o">[</span><span class="n">position</span><span class="o">]);</span>
</span><span class='line'>            <span class="n">holder</span><span class="o">.</span><span class="na">icon</span><span class="o">.</span><span class="na">setImageBitmap</span><span class="o">((</span><span class="n">position</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">mIcon1</span> <span class="o">:</span> <span class="n">mIcon2</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">return</span> <span class="n">convertView</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ViewHolder</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">TextView</span> <span class="n">text</span><span class="o">;</span>
</span><span class='line'>            <span class="n">ImageView</span> <span class="n">icon</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>        <span class="n">setListAdapter</span><span class="o">(</span><span class="k">new</span> <span class="n">EfficientAdapter</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">DATA</span> <span class="o">=</span> <span class="n">Cheeses</span><span class="o">.</span><span class="na">sCheeseStrings</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve highlighted the problematic line. It turns out that you have to use another overload of LayoutInflater.inflate method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">convertView</span> <span class="o">=</span> <span class="n">mInflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">list_item_icon_text</span><span class="o">,</span> <span class="n">parent</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>We set the attachToRoot to false, because we just want to properly intialize LayoutParams for the LinearLayout of the item and let the ListView to add the inflated views wherever it needs. In fact, setting it to true causes exception to be thrown from AdapterView:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">UnsupportedOperationException</span><span class="o">:</span> <span class="n">addView</span><span class="o">(</span><span class="n">View</span><span class="o">,</span> <span class="n">LayoutParams</span><span class="o">)</span> <span class="n">is</span> <span class="n">not</span> <span class="n">supported</span> <span class="n">in</span> <span class="n">AdapterView</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">AdapterView</span><span class="o">.</span><span class="na">addView</span><span class="o">(</span><span class="n">AdapterView</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">461</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">LayoutInflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">LayoutInflater</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">416</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">LayoutInflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">LayoutInflater</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">320</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">LayoutInflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">LayoutInflater</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">276</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">fu</span><span class="o">.</span><span class="na">InflaterBugActivity</span><span class="n">$EfficientAdapter</span><span class="o">.</span><span class="na">getView</span><span class="o">(</span><span class="n">InflaterBugActivity</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">77</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">AbsListView</span><span class="o">.</span><span class="na">obtainView</span><span class="o">(</span><span class="n">AbsListView</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1430</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">ListView</span><span class="o">.</span><span class="na">makeAndAddView</span><span class="o">(</span><span class="n">ListView</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1745</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">ListView</span><span class="o">.</span><span class="na">fillDown</span><span class="o">(</span><span class="n">ListView</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">670</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">ListView</span><span class="o">.</span><span class="na">fillFromTop</span><span class="o">(</span><span class="n">ListView</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">727</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">ListView</span><span class="o">.</span><span class="na">layoutChildren</span><span class="o">(</span><span class="n">ListView</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1598</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">AbsListView</span><span class="o">.</span><span class="na">onLayout</span><span class="o">(</span><span class="n">AbsListView</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1260</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">View</span><span class="o">.</span><span class="na">layout</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">7175</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">FrameLayout</span><span class="o">.</span><span class="na">onLayout</span><span class="o">(</span><span class="n">FrameLayout</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">338</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">View</span><span class="o">.</span><span class="na">layout</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">7175</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">LinearLayout</span><span class="o">.</span><span class="na">setChildFrame</span><span class="o">(</span><span class="n">LinearLayout</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1254</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">LinearLayout</span><span class="o">.</span><span class="na">layoutVertical</span><span class="o">(</span><span class="n">LinearLayout</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1130</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">LinearLayout</span><span class="o">.</span><span class="na">onLayout</span><span class="o">(</span><span class="n">LinearLayout</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1047</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">View</span><span class="o">.</span><span class="na">layout</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">7175</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">FrameLayout</span><span class="o">.</span><span class="na">onLayout</span><span class="o">(</span><span class="n">FrameLayout</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">338</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">View</span><span class="o">.</span><span class="na">layout</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">7175</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">ViewRoot</span><span class="o">.</span><span class="na">performTraversals</span><span class="o">(</span><span class="n">ViewRoot</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1140</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">ViewRoot</span><span class="o">.</span><span class="na">handleMessage</span><span class="o">(</span><span class="n">ViewRoot</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1859</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Handler</span><span class="o">.</span><span class="na">dispatchMessage</span><span class="o">(</span><span class="n">Handler</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">99</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Looper</span><span class="o">.</span><span class="na">loop</span><span class="o">(</span><span class="n">Looper</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">123</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">ActivityThread</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">ActivityThread</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">3683</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Method</span><span class="o">.</span><span class="na">invokeNative</span><span class="o">(</span><span class="n">Native</span> <span class="n">Method</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">Method</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">507</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">ZygoteInit</span><span class="n">$MethodAndArgsCaller</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">ZygoteInit</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">839</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">ZygoteInit</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">ZygoteInit</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">597</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">dalvik</span><span class="o">.</span><span class="na">system</span><span class="o">.</span><span class="na">NativeStart</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">Native</span> <span class="n">Method</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s the application screenshot after the change:</p>

<p><img class="center" src="/images/fixed.png"></p>

<p>Ugly, but that&rsquo;s exactly what we should get after setting layout height to 150dip.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/19/on-cachepolicy-uribuilder-and-mobile/">On CachePolicy, UriBuilder and Mobile .NET</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-19T11:00:00+01:00" pubdate data-updated="true">Feb 19<span>th</span>, 2012</time>
        
           | <a href="/blog/2012/02/19/on-cachepolicy-uribuilder-and-mobile/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/02/19/on-cachepolicy-uribuilder-and-mobile/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the Windows Phone 7 application I was working on there was a problem with some WebRequest caching. I&rsquo;m not sure if it should have been fixed on the client side or server side, but since it&rsquo;s just a matter of setting proper CachePolicy property of WebRequest I was going to add it to mobile application.</p>

<p>Imagine my surprise when I found out that CachePolicy is not supported on Windows Phone 7. The obvious workaround is adding an URI param <code>no-cache=MS_FROM_EPOCH</code> or something like that.</p>

<p>Now, if you&rsquo;d ask me what is the cardinal example of stuff that shouldn&rsquo;t be done using string concatenation, but is notoriously done that way, I&rsquo;d answer: URI building. It&rsquo;s highly structured string with <a href="http://tools.ietf.org/html/rfc3986">RFC</a>, so it stands to reason to create and use a dedicated builder and parsers API to make sure everything is well-formed.</p>

<p>Let&rsquo;s take a look at UriBuilder class and URIs in general. All the stuff between ? and # (VERIFY) is called query string, which contains key-value pairs separated by &amp;s. What kind of API for query string would make sense? An IDictionary&lt;String, String>! What API is presented by UriBuilder? A string! Take a look at the <a href="http://msdn.microsoft.com/en-us/library/system.uribuilder.query.aspx">documentation</a>. Here&rsquo;s the best part:</p>

<blockquote><p><b>NOTE</b> Do not append a string directly to this property. If the length of Query is greater than 1, retrieve the property value as a string, remove the leading question mark, append the new query string, and set the property with the combined string.</p></blockquote>


<p>Ridiculous. Seriously, MS, I don&rsquo;t care it&rsquo;s transformed to a string, it&rsquo;s a key-value dictionary, so let me treat it as such!</p>

<p>Fortunately C# has this nice feature called extension methods, meaning we can &ldquo;add&rdquo; a method to a class. There are no extension properties, but we can have a method like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="n">UriBuilder</span> <span class="nf">WithQueryParam</span><span class="p">(</span><span class="k">this</span> <span class="n">UriBuilder</span> <span class="n">uri</span><span class="p">,</span> <span class="n">String</span> <span class="n">key</span><span class="p">,</span> <span class="n">String</span> <span class="k">value</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>But now we need to check for duplicate keys and for that we have to parse existing query string. Fortunately there is a method for this: <a href="http://msdn.microsoft.com/en-us/library/system.web.httputility.parsequerystring.aspx">HttpUtility.ParseQueryString</a>.</p>

<p>Except it&rsquo;s not available on mobile .NET. Again. But why?</p>

<p>The same thing irritate me when I worked on Blackberry apps and I had to put up with Java ME no String.format, no date handling methods, no generics and sane collections. But I understand that Java ME is supposed to work on wider range of devices, some of them with very limited CPU and RAM resources, so every cycle and every byte of memory matters.</p>

<p>Now let&rsquo;s take a look at Windows Phone 7 <a href="http://en.wikipedia.org/wiki/Windows_Phone#System_requirements">hardware requirements for manufacturers</a>: 256MB of RAM and 800MHz CPU. I&rsquo;m not an .NET expert, but I&rsquo;d hazard a guess that supporting  full desktop .NET would not make any difference on those powerhouses. Hell, you should be able to send a man to the Moon using this hardware, so please, can I have a query string parser?</p>

<p>Is it some kind of Windows Mobile 6 legacy, or just a very bad MS joke that non-MS people don&rsquo;t get?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/16/quest-for-paramerized-converter-for/">The Quest for Paramerized Converter for Windows Phone 7</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-16T13:16:00+01:00" pubdate data-updated="true">Feb 16<span>th</span>, 2012</time>
        
           | <a href="/blog/2012/02/16/quest-for-paramerized-converter-for/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/02/16/quest-for-paramerized-converter-for/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Warning:</strong> this is going to be a long post, because I want to provide full background for the issues I found. Also, none of the code posted here works in 100% of cases.</p>

<p>Recently I was involved in refactoring a program written by interns, which included an over engineered and messed up solution for application settings. I had plenty of time and, despite of the messed up implementation, the original idea might be useful for any form filled by user, so instead of scraping the whole thing I decided to clean it up.</p>

<p>Every type of setting is represented by different class derived from common base. The model of settings consist of a collection of base class objects. That collection is bound to ItemsSource property of ListBox and instead of single data template I use template selector, which creates different UI controls for different setting type.</p>

<p>There is a BooleanSetting, which is represented by a single ToggleSwitch from <a href="http://silverlight.codeplex.com/">Silverlight from Windows Phone Toolkit</a>. There is a ClosedListSetting, represented by ListPicker, which is used for a setting where user can choose one of many options from a predefined list (hence the name). Finally there is a OpenListSetting, which is just like a ClosedListSetting, except there is the &ldquo;Other&rdquo; option which allows user to enter any value. On web forms such field is usually represented as a radio button group with an input box beside the &ldquo;Other&rdquo; option.</p>

<p>For UI consistency I wanted to represent the OpenListSetting using ListPicker, and when the user would select the &ldquo;Other&rdquo; option, additional entry field will appear. It seemed really easy, I thought I&rsquo;ll just bind the visibility of the custom entry field to ListPicker&rsquo;s SelectedIndex property with a value converter.</p>

<p>The first complication is that the position of custom option might be different for a different settings &ndash; usually it&rsquo;s the last one, so it depends on the number of predefined options; for maximum flexibility it should be possible to have many custom options in one OpenListSetting. The obvious solution is to bind some value to converter&rsquo;s parameter property.</p>

<p>Quick search on Google reveals the major flaw in that plan, to wit, you cannot use the binding for converter parameter. There is a Multibinding, which sounds like a likely solution (after all I want to bind visibility to two properties and an operation between those properties), but apparently it&rsquo;s not available in Silverlight for Windows Phone 7. Yay, it&rsquo;s Java ME crap all over again!</p>

<p>The suggested workaround is creating a converter as a non-visual FrameworkElement, with parameter as a dependency property, which can be used in binding. I created a base class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">ConverterWithBindingParameter</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">TConverter</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">FrameworkElement</span><span class="p">,</span> <span class="n">IValueConverter</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">DependencyProperty</span> <span class="n">ParameterProperty</span> <span class="p">=</span> <span class="n">DependencyProperty</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span>
</span><span class='line'>        <span class="s">&quot;BindingParameter&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">),</span>
</span><span class='line'>        <span class="k">typeof</span><span class="p">(</span><span class="n">TConverter</span><span class="p">),</span>
</span><span class='line'>        <span class="k">null</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">T</span> <span class="n">BindingParameter</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="n">GetValue</span><span class="p">(</span><span class="n">ParameterProperty</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>        <span class="k">set</span> <span class="p">{</span> <span class="n">SetValue</span><span class="p">(</span><span class="n">ParameterProperty</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">abstract</span> <span class="k">public</span> <span class="kt">object</span> <span class="nf">Convert</span><span class="p">(</span><span class="kt">object</span> <span class="k">value</span><span class="p">,</span> <span class="n">Type</span> <span class="n">targetType</span><span class="p">,</span> <span class="kt">object</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">CultureInfo</span> <span class="n">culture</span><span class="p">);</span>
</span><span class='line'>    <span class="k">abstract</span> <span class="k">public</span> <span class="kt">object</span> <span class="nf">ConvertBack</span><span class="p">(</span><span class="kt">object</span> <span class="k">value</span><span class="p">,</span> <span class="n">Type</span> <span class="n">targetType</span><span class="p">,</span> <span class="kt">object</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">CultureInfo</span> <span class="n">culture</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then derived the concrete converter for a problem at hand:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">EqualToVisibilityConverter</span> <span class="p">:</span> <span class="n">ConverterWithBindingParameter</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">EqualToVisibilityConverter</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">public</span> <span class="kt">object</span> <span class="nf">Convert</span><span class="p">(</span><span class="kt">object</span> <span class="k">value</span><span class="p">,</span> <span class="n">Type</span> <span class="n">targetType</span><span class="p">,</span> <span class="kt">object</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">CultureInfo</span> <span class="n">culture</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="k">value</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">BindingParameter</span><span class="p">))</span> <span class="p">?</span> <span class="n">Visibility</span><span class="p">.</span><span class="n">Visible</span> <span class="p">:</span> <span class="n">Visibility</span><span class="p">.</span><span class="n">Collapsed</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">public</span> <span class="kt">object</span> <span class="nf">ConvertBack</span><span class="p">(</span><span class="kt">object</span> <span class="k">value</span><span class="p">,</span> <span class="n">Type</span> <span class="n">targetType</span><span class="p">,</span> <span class="kt">object</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">CultureInfo</span> <span class="n">culture</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotImplementedException</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Edit XAML, rebuild, run, kaboom:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="n">System</span><span class="p">.</span><span class="n">ArgumentException</span> <span class="n">was</span> <span class="n">unhandled</span>
</span><span class='line'>    <span class="n">StackTrace</span><span class="p">:</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">RuntimeMethodInfo</span><span class="p">.</span><span class="n">InternalInvoke</span><span class="p">(</span><span class="n">Object</span> <span class="n">obj</span><span class="p">,</span> <span class="n">BindingFlags</span> <span class="n">invokeAttr</span><span class="p">,</span> <span class="n">Binder</span> <span class="n">binder</span><span class="p">,</span> <span class="n">Object</span><span class="p">[]</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">CultureInfo</span> <span class="n">culture</span><span class="p">,</span> <span class="n">StackCrawlMark</span><span class="p">&amp;</span> <span class="n">stackMark</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">RuntimePropertyInfo</span><span class="p">.</span><span class="n">InternalSetValue</span><span class="p">(</span><span class="n">PropertyInfo</span> <span class="n">thisProperty</span><span class="p">,</span> <span class="n">Object</span> <span class="n">obj</span><span class="p">,</span> <span class="n">Object</span> <span class="k">value</span><span class="p">,</span> <span class="n">Object</span><span class="p">[]</span> <span class="n">index</span><span class="p">,</span> <span class="n">StackCrawlMark</span><span class="p">&amp;</span> <span class="n">stackMark</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">RuntimePropertyInfo</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">Object</span> <span class="n">obj</span><span class="p">,</span> <span class="n">Object</span> <span class="k">value</span><span class="p">,</span> <span class="n">Object</span><span class="p">[]</span> <span class="n">index</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XamlMemberInfo</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">Object</span> <span class="n">target</span><span class="p">,</span> <span class="n">Object</span> <span class="k">value</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XamlManagedRuntimeRPInvokes</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">XamlTypeToken</span> <span class="n">inType</span><span class="p">,</span> <span class="n">XamlQualifiedObject</span><span class="p">&amp;</span> <span class="n">inObj</span><span class="p">,</span> <span class="n">XamlPropertyToken</span> <span class="n">inProperty</span><span class="p">,</span> <span class="n">XamlQualifiedObject</span><span class="p">&amp;</span> <span class="n">inValue</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">MeasureOverrideNative</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">element</span><span class="p">,</span> <span class="n">Single</span> <span class="n">inWidth</span><span class="p">,</span> <span class="n">Single</span> <span class="n">inHeight</span><span class="p">,</span> <span class="n">Single</span><span class="p">&amp;</span> <span class="n">outWidth</span><span class="p">,</span> <span class="n">Single</span><span class="p">&amp;</span> <span class="n">outHeight</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">FrameworkElement_MeasureOverride</span><span class="p">(</span><span class="n">FrameworkElement</span> <span class="n">element</span><span class="p">,</span> <span class="n">Size</span> <span class="n">availableSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">FrameworkElement</span><span class="p">.</span><span class="n">MeasureOverride</span><span class="p">(</span><span class="n">Size</span> <span class="n">availableSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">FrameworkElement</span><span class="p">.</span><span class="n">MeasureOverride</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">nativeTarget</span><span class="p">,</span> <span class="n">Double</span> <span class="n">inWidth</span><span class="p">,</span> <span class="n">Double</span> <span class="n">inHeight</span><span class="p">,</span> <span class="n">Double</span><span class="p">&amp;</span> <span class="n">outWidth</span><span class="p">,</span> <span class="n">Double</span><span class="p">&amp;</span> <span class="n">outHeight</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">Measure_WithDesiredSizeNative</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">element</span><span class="p">,</span> <span class="n">Single</span> <span class="n">inWidth</span><span class="p">,</span> <span class="n">Single</span> <span class="n">inHeight</span><span class="p">,</span> <span class="n">Single</span><span class="p">&amp;</span> <span class="n">outWidth</span><span class="p">,</span> <span class="n">Single</span><span class="p">&amp;</span> <span class="n">outHeight</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">UIElement_Measure_WithDesiredSize</span><span class="p">(</span><span class="n">UIElement</span> <span class="n">element</span><span class="p">,</span> <span class="n">Size</span> <span class="n">availableSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">UIElement</span><span class="p">.</span><span class="n">Measure_WithDesiredSize</span><span class="p">(</span><span class="n">Size</span> <span class="n">availableSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">Controls</span><span class="p">.</span><span class="n">VirtualizingStackPanel</span><span class="p">.</span><span class="n">MeasureChild</span><span class="p">(</span><span class="n">UIElement</span> <span class="n">child</span><span class="p">,</span> <span class="n">Size</span> <span class="n">layoutSlotSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">Controls</span><span class="p">.</span><span class="n">VirtualizingStackPanel</span><span class="p">.</span><span class="n">MeasureOverride</span><span class="p">(</span><span class="n">Size</span> <span class="n">constraint</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">FrameworkElement</span><span class="p">.</span><span class="n">MeasureOverride</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">nativeTarget</span><span class="p">,</span> <span class="n">Double</span> <span class="n">inWidth</span><span class="p">,</span> <span class="n">Double</span> <span class="n">inHeight</span><span class="p">,</span> <span class="n">Double</span><span class="p">&amp;</span> <span class="n">outWidth</span><span class="p">,</span> <span class="n">Double</span><span class="p">&amp;</span> <span class="n">outHeight</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">MeasureOverrideNative</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">element</span><span class="p">,</span> <span class="n">Single</span> <span class="n">inWidth</span><span class="p">,</span> <span class="n">Single</span> <span class="n">inHeight</span><span class="p">,</span> <span class="n">Single</span><span class="p">&amp;</span> <span class="n">outWidth</span><span class="p">,</span> <span class="n">Single</span><span class="p">&amp;</span> <span class="n">outHeight</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">FrameworkElement_MeasureOverride</span><span class="p">(</span><span class="n">FrameworkElement</span> <span class="n">element</span><span class="p">,</span> <span class="n">Size</span> <span class="n">availableSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">FrameworkElement</span><span class="p">.</span><span class="n">MeasureOverride</span><span class="p">(</span><span class="n">Size</span> <span class="n">availableSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">Controls</span><span class="p">.</span><span class="n">ScrollContentPresenter</span><span class="p">.</span><span class="n">MeasureOverride</span><span class="p">(</span><span class="n">Size</span> <span class="n">constraint</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">FrameworkElement</span><span class="p">.</span><span class="n">MeasureOverride</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">nativeTarget</span><span class="p">,</span> <span class="n">Double</span> <span class="n">inWidth</span><span class="p">,</span> <span class="n">Double</span> <span class="n">inHeight</span><span class="p">,</span> <span class="n">Double</span><span class="p">&amp;</span> <span class="n">outWidth</span><span class="p">,</span> <span class="n">Double</span><span class="p">&amp;</span> <span class="n">outHeight</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">MeasureNative</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">element</span><span class="p">,</span> <span class="n">Single</span> <span class="n">inWidth</span><span class="p">,</span> <span class="n">Single</span> <span class="n">inHeight</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">UIElement_Measure</span><span class="p">(</span><span class="n">UIElement</span> <span class="n">element</span><span class="p">,</span> <span class="n">Size</span> <span class="n">availableSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">UIElement</span><span class="p">.</span><span class="n">Measure</span><span class="p">(</span><span class="n">Size</span> <span class="n">availableSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">Controls</span><span class="p">.</span><span class="n">ScrollViewer</span><span class="p">.</span><span class="n">MeasureOverride</span><span class="p">(</span><span class="n">Size</span> <span class="n">constraint</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">FrameworkElement</span><span class="p">.</span><span class="n">MeasureOverride</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">nativeTarget</span><span class="p">,</span> <span class="n">Double</span> <span class="n">inWidth</span><span class="p">,</span> <span class="n">Double</span> <span class="n">inHeight</span><span class="p">,</span> <span class="n">Double</span><span class="p">&amp;</span> <span class="n">outWidth</span><span class="p">,</span> <span class="n">Double</span><span class="p">&amp;</span> <span class="n">outHeight</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">MeasureOverrideNative</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">element</span><span class="p">,</span> <span class="n">Single</span> <span class="n">inWidth</span><span class="p">,</span> <span class="n">Single</span> <span class="n">inHeight</span><span class="p">,</span> <span class="n">Single</span><span class="p">&amp;</span> <span class="n">outWidth</span><span class="p">,</span> <span class="n">Single</span><span class="p">&amp;</span> <span class="n">outHeight</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">FrameworkElement_MeasureOverride</span><span class="p">(</span><span class="n">FrameworkElement</span> <span class="n">element</span><span class="p">,</span> <span class="n">Size</span> <span class="n">availableSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">FrameworkElement</span><span class="p">.</span><span class="n">MeasureOverride</span><span class="p">(</span><span class="n">Size</span> <span class="n">availableSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">FrameworkElement</span><span class="p">.</span><span class="n">MeasureOverride</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">nativeTarget</span><span class="p">,</span> <span class="n">Double</span> <span class="n">inWidth</span><span class="p">,</span> <span class="n">Double</span> <span class="n">inHeight</span><span class="p">,</span> <span class="n">Double</span><span class="p">&amp;</span> <span class="n">outWidth</span><span class="p">,</span> <span class="n">Double</span><span class="p">&amp;</span> <span class="n">outHeight</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">MeasureOverrideNative</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">element</span><span class="p">,</span> <span class="n">Single</span> <span class="n">inWidth</span><span class="p">,</span> <span class="n">Single</span> <span class="n">inHeight</span><span class="p">,</span> <span class="n">Single</span><span class="p">&amp;</span> <span class="n">outWidth</span><span class="p">,</span> <span class="n">Single</span><span class="p">&amp;</span> <span class="n">outHeight</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">FrameworkElement_MeasureOverride</span><span class="p">(</span><span class="n">FrameworkElement</span> <span class="n">element</span><span class="p">,</span> <span class="n">Size</span> <span class="n">availableSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">FrameworkElement</span><span class="p">.</span><span class="n">MeasureOverride</span><span class="p">(</span><span class="n">Size</span> <span class="n">availableSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">FrameworkElement</span><span class="p">.</span><span class="n">MeasureOverride</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">nativeTarget</span><span class="p">,</span> <span class="n">Double</span> <span class="n">inWidth</span><span class="p">,</span> <span class="n">Double</span> <span class="n">inHeight</span><span class="p">,</span> <span class="n">Double</span><span class="p">&amp;</span> <span class="n">outWidth</span><span class="p">,</span> <span class="n">Double</span><span class="p">&amp;</span> <span class="n">outHeight</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>On a hunch I created non-generic version of my converter and it seemed to work. Oh, so I can&rsquo;t use generic base for UI controls? Nice job MS.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">EqualToVisibilityConverter</span> <span class="p">:</span> <span class="n">FrameworkElement</span><span class="p">,</span> <span class="n">IValueConverter</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">DependencyProperty</span> <span class="n">ParameterProperty</span> <span class="p">=</span> <span class="n">DependencyProperty</span><span class="p">.</span><span class="n">RegisterAttached</span><span class="p">(</span>
</span><span class='line'>        <span class="s">&quot;BindingParameter&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="k">typeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
</span><span class='line'>        <span class="k">typeof</span><span class="p">(</span><span class="n">EqualToVisibilityConverter</span><span class="p">),</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">PropertyMetadata</span><span class="p">(</span><span class="m">0</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">OnBindingParameterChanged</span><span class="p">(</span><span class="n">DependencyObject</span> <span class="n">d</span><span class="p">,</span> <span class="n">DependencyPropertyChangedEventArgs</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">BindingParameter</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">GetValue</span><span class="p">(</span><span class="n">ParameterProperty</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>        <span class="k">set</span> <span class="p">{</span> <span class="n">SetValue</span><span class="p">(</span><span class="n">ParameterProperty</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">object</span> <span class="nf">Convert</span><span class="p">(</span><span class="kt">object</span> <span class="k">value</span><span class="p">,</span> <span class="n">Type</span> <span class="n">targetType</span><span class="p">,</span> <span class="kt">object</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">CultureInfo</span> <span class="n">culture</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">bp</span> <span class="p">=</span> <span class="n">BindingParameter</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="k">value</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">BindingParameter</span><span class="p">))</span> <span class="p">?</span> <span class="n">Visibility</span><span class="p">.</span><span class="n">Visible</span> <span class="p">:</span> <span class="n">Visibility</span><span class="p">.</span><span class="n">Collapsed</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">object</span> <span class="nf">ConvertBack</span><span class="p">(</span><span class="kt">object</span> <span class="k">value</span><span class="p">,</span> <span class="n">Type</span> <span class="n">targetType</span><span class="p">,</span> <span class="kt">object</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">CultureInfo</span> <span class="n">culture</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotImplementedException</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that I wrote &ldquo;seemed to work&rdquo;. It means only that the code didn&rsquo;t explode in my face, but it didn&rsquo;t work quite as I expected. Here&rsquo;s the quick breakdown: when the visibility converter is called for the first time, the bound parameter is null. Then the dependency value is changed (at least the callback is called; curiously, the setter is not) and the bound parameter is initialized with a proper value, but there is no way to invalidate the conversion result.</p>

<p>That gave me another idea: why use IValueConverter interface at all? Let&rsquo;s create an UI element with 2 dependency properties for arguments and one property for result of binary operation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">EqualToVisibilityConverter</span> <span class="p">:</span> <span class="n">FrameworkElement</span><span class="p">,</span> <span class="n">INotifyPropertyChanged</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">DependencyProperty</span> <span class="n">LeftArgumentProperty</span> <span class="p">=</span> <span class="n">DependencyProperty</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span>
</span><span class='line'>        <span class="s">&quot;LeftArgument&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="k">typeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
</span><span class='line'>        <span class="k">typeof</span><span class="p">(</span><span class="n">EqualToVisibilityConverter</span><span class="p">),</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">PropertyMetadata</span><span class="p">(</span><span class="n">OnArgumentChanged</span><span class="p">)</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">DependencyProperty</span> <span class="n">RightArgumentProperty</span> <span class="p">=</span> <span class="n">DependencyProperty</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span>
</span><span class='line'>        <span class="s">&quot;RightArgument&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="k">typeof</span><span class="p">(</span><span class="n">Visibility</span><span class="p">),</span>
</span><span class='line'>        <span class="k">typeof</span><span class="p">(</span><span class="n">EqualToVisibilityConverter</span><span class="p">),</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">PropertyMetadata</span><span class="p">(</span><span class="n">OnArgumentChanged</span><span class="p">)</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">OnArgumentChanged</span><span class="p">(</span><span class="n">DependencyObject</span> <span class="n">d</span><span class="p">,</span> <span class="n">DependencyPropertyChangedEventArgs</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">EqualToVisibilityConverter</span> <span class="n">converter</span> <span class="p">=</span> <span class="n">d</span> <span class="k">as</span> <span class="n">EqualToVisibilityConverter</span><span class="p">;</span>
</span><span class='line'>        <span class="n">converter</span><span class="p">.</span><span class="n">Result</span> <span class="p">=</span> <span class="p">(</span><span class="n">converter</span><span class="p">.</span><span class="n">LeftArgument</span> <span class="p">==</span> <span class="n">converter</span><span class="p">.</span><span class="n">RightArgument</span><span class="p">)</span> <span class="p">?</span> <span class="n">Visibility</span><span class="p">.</span><span class="n">Visible</span> <span class="p">:</span> <span class="n">Visibility</span><span class="p">.</span><span class="n">Collapsed</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">LeftArgument</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">GetValue</span><span class="p">(</span><span class="n">LeftArgumentProperty</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>        <span class="k">set</span> <span class="p">{</span> <span class="n">SetValue</span><span class="p">(</span><span class="n">LeftArgumentProperty</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">RightArgument</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">GetValue</span><span class="p">(</span><span class="n">RightArgumentProperty</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>        <span class="k">set</span> <span class="p">{</span> <span class="n">SetValue</span><span class="p">(</span><span class="n">RightArgumentProperty</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">Visibility</span> <span class="n">_result</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">Visibility</span> <span class="n">Result</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_result</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>        <span class="k">set</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="k">value</span> <span class="p">!=</span> <span class="n">_result</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="n">_result</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
</span><span class='line'>                <span class="n">OnPropertyChanged</span><span class="p">(</span><span class="s">&quot;Result&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">event</span> <span class="n">PropertyChangedEventHandler</span> <span class="n">PropertyChanged</span><span class="p">;</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">void</span> <span class="nf">OnPropertyChanged</span><span class="p">(</span><span class="kt">string</span> <span class="n">propertyName</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">null</span> <span class="p">!=</span> <span class="n">PropertyChanged</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">PropertyChanged</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">new</span> <span class="n">PropertyChangedEventArgs</span><span class="p">(</span><span class="n">propertyName</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the callbacks of dependency properties can trigger the result recalculation and everything will be fine and dandy. Edit XAML, rebuild, run, KABOOM! This time application blew up, but I didn&rsquo;t even get a call stack, it just closed without any message.</p>

<p>This. Is. Fucking. Ridiculous.</p>

<p>At this moment I decided I already lost enough time on this crap, so I just said &ldquo;screw it&rdquo; and added additional property to OpenListSetting class.</p>

<p>This is when I finally got why the MVVM pattern got so much traction with XAML developers. I always assumed that it&rsquo;s supposed to be used for big model adaptations, and all minor stuff should be done in binding converters. However it seems that you have to use ViewModel for anything remotely useful. Don&rsquo;t get me wrong: I agree that preventing pollution of Model by stuff needed by View is a Good Thing TM, but I think a separation of View into View and ViewModel is necessary only because of limitations of XAML.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/02/messagebox-crash-on-windows-phone-7/">MessageBox Crash on Windows Phone 7</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-02T22:05:00+01:00" pubdate data-updated="true">Feb 2<span>nd</span>, 2012</time>
        
           | <a href="/blog/2012/02/02/messagebox-crash-on-windows-phone-7/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/02/02/messagebox-crash-on-windows-phone-7/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Guess what&rsquo;s wrong with this Application Bar button handler:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">private</span> <span class="k">void</span> <span class="nf">OnAboutButtonClick</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="s">&quot;Blah blah blah, our app v1.0&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you answered &ldquo;you&rsquo;re using hardcoded string instead of application resource&rdquo; you are of course right, but that&rsquo;s not the worst problem with it, so no cookie for you. If the user clicks the application bar button twice before the message box is shown it crashes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="n">System</span><span class="p">.</span><span class="n">Exception</span> <span class="n">was</span> <span class="n">unhandled</span>
</span><span class='line'>  <span class="n">Message</span><span class="p">=</span><span class="m">0</span><span class="n">x8000ffff</span>
</span><span class='line'>  <span class="n">StackTrace</span><span class="p">:</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">CheckHResult</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">hr</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">MessageBox_ShowCore</span><span class="p">(</span><span class="n">String</span> <span class="n">messageBoxText</span><span class="p">,</span> <span class="n">String</span> <span class="n">caption</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">type</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">MessageBox</span><span class="p">.</span><span class="n">ShowCore</span><span class="p">(</span><span class="n">String</span> <span class="n">messageBoxText</span><span class="p">,</span> <span class="n">String</span> <span class="n">caption</span><span class="p">,</span> <span class="n">MessageBoxButton</span> <span class="n">button</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="n">String</span> <span class="n">messageBoxText</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">PhoneApp1</span><span class="p">.</span><span class="n">MainPage</span><span class="p">.</span><span class="n">OnAboutButtonClick</span><span class="p">(</span><span class="n">Object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Phone</span><span class="p">.</span><span class="n">Shell</span><span class="p">.</span><span class="n">ApplicationBarItemContainer</span><span class="p">.</span><span class="n">FireEventHandler</span><span class="p">(</span><span class="n">EventHandler</span> <span class="n">handler</span><span class="p">,</span> <span class="n">Object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Phone</span><span class="p">.</span><span class="n">Shell</span><span class="p">.</span><span class="n">ApplicationBarIconButton</span><span class="p">.</span><span class="n">ClickEvent</span><span class="p">()</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Phone</span><span class="p">.</span><span class="n">Shell</span><span class="p">.</span><span class="n">ApplicationBarIconButtonContainer</span><span class="p">.</span><span class="n">ClickEvent</span><span class="p">()</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Phone</span><span class="p">.</span><span class="n">Shell</span><span class="p">.</span><span class="n">ApplicationBar</span><span class="p">.</span><span class="n">OnCommand</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">idCommand</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Phone</span><span class="p">.</span><span class="n">Shell</span><span class="p">.</span><span class="n">Interop</span><span class="p">.</span><span class="n">NativeCallbackInteropWrapper</span><span class="p">.</span><span class="n">OnCommand</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">idCommand</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">MessageBox_ShowCoreNative</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">context</span><span class="p">,</span> <span class="n">String</span> <span class="n">messageBoxText</span><span class="p">,</span> <span class="n">String</span> <span class="n">caption</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">type</span><span class="p">,</span> <span class="n">Int32</span><span class="p">&amp;</span> <span class="n">result</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">MessageBox_ShowCore</span><span class="p">(</span><span class="n">String</span> <span class="n">messageBoxText</span><span class="p">,</span> <span class="n">String</span> <span class="n">caption</span><span class="p">,</span> <span class="n">UInt32</span> <span class="n">type</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">MessageBox</span><span class="p">.</span><span class="n">ShowCore</span><span class="p">(</span><span class="n">String</span> <span class="n">messageBoxText</span><span class="p">,</span> <span class="n">String</span> <span class="n">caption</span><span class="p">,</span> <span class="n">MessageBoxButton</span> <span class="n">button</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="n">String</span> <span class="n">messageBoxText</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">PhoneApp1</span><span class="p">.</span><span class="n">MainPage</span><span class="p">.</span><span class="n">OnAboutButtonClick</span><span class="p">(</span><span class="n">Object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Phone</span><span class="p">.</span><span class="n">Shell</span><span class="p">.</span><span class="n">ApplicationBarItemContainer</span><span class="p">.</span><span class="n">FireEventHandler</span><span class="p">(</span><span class="n">EventHandler</span> <span class="n">handler</span><span class="p">,</span> <span class="n">Object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Phone</span><span class="p">.</span><span class="n">Shell</span><span class="p">.</span><span class="n">ApplicationBarIconButton</span><span class="p">.</span><span class="n">ClickEvent</span><span class="p">()</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Phone</span><span class="p">.</span><span class="n">Shell</span><span class="p">.</span><span class="n">ApplicationBarIconButtonContainer</span><span class="p">.</span><span class="n">ClickEvent</span><span class="p">()</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Phone</span><span class="p">.</span><span class="n">Shell</span><span class="p">.</span><span class="n">ApplicationBar</span><span class="p">.</span><span class="n">OnCommand</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">idCommand</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Phone</span><span class="p">.</span><span class="n">Shell</span><span class="p">.</span><span class="n">Interop</span><span class="p">.</span><span class="n">NativeCallbackInteropWrapper</span><span class="p">.</span><span class="n">OnCommand</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">idCommand</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The interesting thing about this stack trace is that it contains two calls to <code>MessageBox.Show()</code>. WTF? Since <code>MessageBox.Show()</code> returns the value, I assumed it&rsquo;s a synchronous call, i.e. no stuff would happen until the user clicks &ldquo;OK&rdquo;. Apparently MessageBox opens internal event loop (which kind of makes sense, since something has to handle the user clicking &ldquo;OK&rdquo;), which handles the second application bar click, tries to open the second message box and the whole application blows up.</p>

<p>Now, you may say &ldquo;It&rsquo;s only a problem if the user intentionally bangs the poor phone like an ADD afflicted monkey on speed&rdquo;. I say &ldquo;Fix your god damn app&rdquo; (and in case anyone from Microsoft would ever read this, I also say &ldquo;Fix your god damn framework&rdquo;).</p>

<p>So what can we do? Using lock is out of the question, since everything is executed in the same thread. So the only option I came up with is a Crappy Boolean Flag Pattern:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">private</span> <span class="kt">bool</span> <span class="n">_msgboxShown</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'><span class="k">private</span> <span class="k">void</span> <span class="nf">OnAboutButtonClick</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(!</span><span class="n">_msgboxShown</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_msgboxShown</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>        <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="s">&quot;Blah blah blah, our app v1.0&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">_msgboxShown</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not elegant, but it works. Of course if you use message boxes for other stuff, create some helper class for this crap.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/01/handling-qml-errors-101/">Handling QML Errors 101</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-01T12:02:00+01:00" pubdate data-updated="true">Feb 1<span>st</span>, 2012</time>
        
           | <a href="/blog/2012/02/01/handling-qml-errors-101/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/02/01/handling-qml-errors-101/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Qt SDK comes with great documentation and examples, but there is hardly any information about handling QML errors. All examples assume that nothing can go wrong during runtime, which is a bit naive approach. Even if your app is completely bug free, the users will find a way to shoot themselves in the foot. They will install your app and then uninstall key plugins ignoring all warnings from system. They will install your app on SD card and then delete some files for some unfathomable reason. And then they will blame you.</p>

<p>Let&rsquo;s consider what happens if you have an error in your main QML file? User sees the black screen, gets pissed off, uninstalls your app and gives it a negative review in Nokia store. Not good. Let&rsquo;s try something different:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">QApplication</span> <span class="n">app</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span><span class='line'>    <span class="n">QDeclarativeView</span> <span class="n">canvas</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">canvas</span><span class="p">.</span><span class="n">setSource</span><span class="p">(</span><span class="n">QLatin1String</span><span class="p">(</span><span class="s">&quot;main.qml&quot;</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">canvas</span><span class="p">.</span><span class="n">errors</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// handle errors</span>
</span><span class='line'>        <span class="n">QMessageBox</span> <span class="n">msgBox</span><span class="p">;</span>
</span><span class='line'>        <span class="n">msgBox</span><span class="p">.</span><span class="n">setText</span><span class="p">(</span><span class="s">&quot;Uh oh, something went terribly wrong!&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">msgBox</span><span class="p">.</span><span class="n">setInformativeText</span><span class="p">(</span>
</span><span class='line'>            <span class="s">&quot;We&#39;re sorry, but it seems there &quot;</span>
</span><span class='line'>            <span class="s">&quot;are some problems with running &quot;</span>
</span><span class='line'>            <span class="s">&quot;our application on your phone.&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">msgBox</span><span class="p">.</span><span class="n">exec</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// optionally set the screen orientation</span>
</span><span class='line'>    <span class="c1">// call show/showFullscreen/showMaximized</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">app</span><span class="p">.</span><span class="n">exec</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Few notes about the snippet above:</p>

<ul>
<li>If you&rsquo;re using the QML Application template from the recent version of Qt Creator you probably have a generated QmlApplicationViewer class instead of raw QDeclarativeView, but the general idea stays the same.</li>
<li>Error handling section above is only a stub. You may ask user to reinstall the application. You may display more information about the error along with some contact information. If your application uses network connection, you should probably ask user if he wants to send an error report.</li>
<li>If you use the QMessageBox or other modal dialog and lock the screen orientation, you mustn&rsquo;t lock the orientation before showing the dialog. In current version of Qt (4.7.4) there is a bug and in case of forced orientation change only dialog buttons are displayed.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/01/31/updating-qt-applications-in-nokia-store/">Updating Qt Applications in Nokia Store</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-31T21:10:00+01:00" pubdate data-updated="true">Jan 31<span>st</span>, 2012</time>
        
           | <a href="/blog/2012/01/31/updating-qt-applications-in-nokia-store/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/01/31/updating-qt-applications-in-nokia-store/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Every Symbian Qt application in Nokia Store consists of two parts: metadata and content files. Metadata is the information about the application visible in Nokia Store, and content files are applications binaries, i.e. sis file. Both parts are separate entities, can be updated independently and have separate Quality Assurance process. It stands to reason: why would anyone have to verify the application binary when you correct a typo in applications  description?</p>

<p>But sometimes you might want to change the description and the binary at the same time. For example I screwed up testing of the first version of my <a href="/blog/2012/01/20/introducing-nu-pogodi/">&ldquo;Nu, Pogodi!&rdquo;</a> game and first few reviews were negative with &ldquo;Doesn&rsquo;t work, shows only black screen&rdquo; comment. I fixed the issue, published new binary and added &ldquo;Version 1.0.1 fixes the black screen issue.&rdquo; text to description. The metadata QA finished earlier, but still the old, malfunctioning binaries were served. Guess what happened &ndash; the next review was also negative, this time with &ldquo;Black screen, cannot download version 1.0.1&rdquo; text. Joy.</p>

<p>So the point is, currently there is no way to update both parts of content at the same time. The solution recommended by Nokia Publish Support is to publish the binaries first, because the QA for that part is longer than for metadata and update the metadata when binaries pass QA.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/01/27/xname-binding-crash-on-windows-phone-71/">X:name Binding Crash on Windows Phone 7.1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-27T11:29:00+01:00" pubdate data-updated="true">Jan 27<span>th</span>, 2012</time>
        
           | <a href="/blog/2012/01/27/xname-binding-crash-on-windows-phone-71/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/01/27/xname-binding-crash-on-windows-phone-71/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I&rsquo;ve started working on the new version of Windows Phone application originally written by interns in my company. One of the first tasks was to migrate from WP 7.0 to 7.1, a.k.a. &ldquo;Windows Phone 7.5&rdquo; (because 7.5 sounds sooooo much better than 7.1), a.k.a. &ldquo;Windows Phone Mango&rdquo;. The transition was generally smooth and it seems we&rsquo;ll be able to clean up some 7.0 specific workarounds, but there was one crash that was quite tricky to track down:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="n">Null</span> <span class="n">Reference</span> <span class="n">Exception</span><span class="p">:</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">CheckHResult</span><span class="p">(</span><span class="n">UInt32</span> <span class="n">hr</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">MS</span><span class="p">.</span><span class="n">Internal</span><span class="p">.</span><span class="n">XcpImports</span><span class="p">.</span><span class="n">UIElement_Measure_WithDesiredSize</span><span class="p">(</span><span class="n">UIElement</span> <span class="n">element</span><span class="p">,</span> <span class="n">Size</span> <span class="n">availableSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">UIElement</span><span class="p">.</span><span class="n">Measure_WithDesiredSize</span><span class="p">(</span><span class="n">Size</span> <span class="n">availableSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">Controls</span><span class="p">.</span><span class="n">VirtualizingStackPanel</span><span class="p">.</span><span class="n">MeasureChild</span><span class="p">(</span><span class="n">UIElement</span> <span class="n">child</span><span class="p">,</span> <span class="n">Size</span> <span class="n">layoutSlotSize</span><span class="p">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">Controls</span><span class="p">.</span><span class="n">VirtualizingStackPanel</span><span class="p">.</span><span class="n">MeasureOverride</span><span class="p">(</span><span class="n">Size</span> <span class="n">constraint</span><span class="p">)</span>
</span><span class='line'>    <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our code wasn&rsquo;t even in a call stack! It turns out that the following code worked on 7.0, but crashed on newer version:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;validationcontrol:validationcontrol</span>
</span><span class='line'>    <span class="na">grid.row=</span><span class="s">&quot;1&quot;</span>
</span><span class='line'>    <span class="na">inputscope=</span><span class="s">&quot;Number&quot;</span>
</span><span class='line'>    <span class="na">lostfocus=</span><span class="s">&quot;OnCustomValueChanged&quot;</span>
</span><span class='line'>    <span class="na">text=</span><span class="s">&quot;{Binding Custom}&quot;</span>
</span><span class='line'>    <span class="na">width=</span><span class="s">&quot;420&quot;</span>
</span><span class='line'>    <span class="na">x:name=</span><span class="s">&quot;{Binding Key}&quot;</span><span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m not sure if using binding for a control name and relying on that information in code behind is a good idea, but I&rsquo;m damn sure it shouldn&rsquo;t crash. And even if it crashes, it should provide some useful information instead of throwing NRE from seemingly random place.</p>

<p>What&rsquo;s the fix for it? Use x:Tag instead of x:Name.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/01/22/how-not-to-test-your-qml-application/">How (Not to) Test Your QML Application for Symbian</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-22T16:15:00+01:00" pubdate data-updated="true">Jan 22<span>nd</span>, 2012</time>
        
           | <a href="/blog/2012/01/22/how-not-to-test-your-qml-application/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/01/22/how-not-to-test-your-qml-application/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>First of all by QML I do not mean <a href="http://sneezy.cs.nott.ac.uk/QML/">this</a>, I mean <a href="http://developer.qt.nokia.com/doc/qt-4.8/qtquick.html">this</a>: a UI module of Qt, the cross-platform framework. The gals and guys at Nokia figured out that modern user interface cannot be fully described by static layout in a XML file. Microsoft figured out that too, but they chickened out and only extended XML a bit and added an &lsquo;a&rsquo; to file extension to make it look like something new. Nokians took a step further and created new language for declarative UI based on JavaScript called QML.</p>

<p>The QML UI components can be defined in two ways: it can be a QML file composed of other components (for instance that&rsquo;s the usual way to define the main UI file) or it can be a C++ extension. Both ways can be used together to create a plugin, which can be imported to your project.</p>

<p>And at last we reach the intended topic of this post: testing. What happens if some QML file defining a component is missing? What happens if the whole plugin is missing or the version of this plugin is lower than the one required by application? QML files are interpreted during runtime, so of course you get the runtime error. In the best scenario it limits the functionality of your app, in the worst case it renders it completely unusable.</p>

<p>But hey, you can catch most of those errors simply by clicking through your application, right? Not exactly, doing so only tells you that in works on one particular device. You might have some plugins already installed, but not included in application&rsquo;s package and your app will work only on the devices which happen to have those plugins, which is not very likely.</p>

<p><img class="center" src="/images/works-on-my-machine-starburst_2.png">
That&rsquo;s exactly the error I made when I published the first version of &ldquo;Nu, Pogodi!&rdquo;. I submitted for Q&amp;A process an application with dependencies to Qt Components 1.1, build with the latest Qt SDK. I&rsquo;ve tested it thoroughly on some devices I had access to and via <a href="http://www.developer.nokia.com/Devices/Remote_device_access/">Remote Device Access</a> service (which BTW rocks; I wish there was a similar service for Android) and everything worked fine. The application was rejected by Q&amp;A, because at the end of 2011 there was some <a href="http://support.publish.nokia.com/?p=3766&amp;type=news">technical issues with Nokia Store and latest Qt</a> and I was told to rebuild my application with old SDK, which included only Qt Components 1.0. I&rsquo;ve tested my game again and everything worked so I published it to Nokia Store. Few days later I received first reviews &ndash; all negative, along the lines &ldquo;doesn&rsquo;t work, beware&rdquo;.</p>

<p>Qt Smart Installer partially prevents those errors, but you still might shoot yourself in the foot in some cases. My game had dependencies to Qt Components 1.1, but the pkg file declared dependency to version 1.0, because it was created with old SDK. When my customers installed the game, the smart installer ensured only that version 1.0 is installed, but my game needed newer version and failed during runtime. I didn&rsquo;t caught this during testing, because all of my devices had latest Qt Components installed.</p>

<p>That was the &ldquo;How not to test your QML application&rdquo; part, now let&rsquo;s get to solution. It&rsquo;s really simple: downgrade all the stuff needed by your application to versions defined in pkg file. To check the current versions of Qt libraries and plugins I recommend using an excellent <a href="http://projects.developer.nokia.com/qtinfo">QtInfo tool</a>. To downgrade Qt you need the sis files distributed with <a href="ftp://ftp.qt.nokia.com/qtsdk/">old Qt SDK versions</a>.</p>

<p>This simple steps should ensure that your application will work properly on all supported devices. Nevertheless, you should prepare for failure and handle all runtime errors in a user friendly way. But that&rsquo;s the topic for another post&hellip;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/01/20/introducing-nu-pogodi/">Introducing: Nu, Pogodi!</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-20T12:05:00+01:00" pubdate data-updated="true">Jan 20<span>th</span>, 2012</time>
        
           | <a href="/blog/2012/01/20/introducing-nu-pogodi/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/01/20/introducing-nu-pogodi/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="center" src="/images/nupogodi.png"></p>

<p>&ldquo;Nu, pogodi!&rdquo; is the first application I&rsquo;ve published in Nokia Store (or any other app store, in fact). It&rsquo;s a remake of a classic handheld console game I used to play in my childhood: you had to place a wolf with a basket under one of four roosts to catch the eggs rolling from them. Despite the extreme simplicity and the obvious flaw in the game plot (namely: what the hell does the wolf need the eggs for?) the game was quite addictive and I spent many hours listening to the hypnotizing ticking of the falling eggs (if you played this game you know what I&rsquo;m talking about).</p>

<p>The handheld console I based my game on is actually a Russian clone of &ldquo;Egg&rdquo; game from Nintendo&rsquo;s &ldquo;Game &amp; Watch&rdquo; game series. The main difference is the graphics &ndash; instead of fox and hen the Russian clone featured the Wolf and the Hare from a &ldquo;Nu, pogodi!&rdquo; cartoon &ndash; hence the name of the game.</p>

<p><img class="center" src="/images/handhelds.jpg"></p>

<p>At the beginning of 2011 I wanted to check out the Qt Quick, which was advertised by Nokia as the best thing since sliced bread. I never liked the go-through-a-boring-tutorials way of learning new things, so I started writing UI for a simple game instead. Few weeks later Nokia announced <a href="http://www.developer.nokia.com/Community/Wiki/The_Quick_Competition_2011Q1">Qt Quick Competition</a> &ndash; an event promoting Qt Quick introduced in Qt 4.7. I&rsquo;ve entered the competition with the early version of my game under the name <a href="http://projects.developer.nokia.com/PAGADI">&ldquo;Nu, Pagadi!&rdquo;</a> (which is, as I learned later, incorrect &ndash; apparently in Russian sometimes you write an &lsquo;o&rsquo;, but pronounce it as &lsquo;a&rsquo;), which didn&rsquo;t won me anything, but at least I had a motivation to work on the game. In accordance with the competition rules I&rsquo;ve published my code under OSS license and forgot about the whole deal.</p>

<p>In November 2011 I&rsquo;ve stumbled upon a &ldquo;Soviet Eggs&rdquo; game in Nokia Store. It seems that some company forked my competition entry, added a splash screen and the menu and charged 2 euros for it. I&rsquo;ve watched the gameplay videos on YouTube, and thought I can do much better version than them. I polished my game, added sound effects, better looking menu and new game mode which resembles the gameplay of original game much more than the one included in the competition entry. All those changes took me about one week worth of evenings and one weekend. Subsequentially I&rsquo;ve <a href="/blog/2012/01/22/how-not-to-test-your-qml-application">screwed up testing</a>, published to Nokia Store a game which silently crashed on 90% of the phones, fixed the problem, and then I screwed up again, this time when <a href="/blog/2012/01/31/updating-qt-applications-in-nokia-store">publishing the update</a>.</p>

<p>Despite the initial issues the game reached top 10 bestseller list in two weeks and stayed there ever since. Try it yourself!</p>

<p><a href="http://store.ovi.com/content/219800"><img class="center" src="/images/nupogodi-banner.png"></a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/9/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/7/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/06/13/beatiful-code-comparisonchain-from-guava/">Beatiful Code: ComparisonChain</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/12/android-loaders/">Android Loaders</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/10/enabling-proguard-for-debug-builds/">ProGuard in Ant Debug Builds</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/22/clicking-unclickable-list-items/">Clicking Unclickable List Items</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/10/android-app-widgets-issues/">Android App Widgets Issues</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/chalup">@chalup</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'chalup',
            count: 0,
            skip_forks: true,
            filter_repos: [ "microorm", "thneed", "dawggenerator", "cerberus" ],
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/106340839330487061995?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Jerzy Chalupski -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'porcupineprogrammer';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
