
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Porcupine Programmer</title>
  <meta name="author" content="Jerzy Chalupski">

  
  <meta name="description" content="Last November I wrote about the new feature in rev11 of Android support package &ndash; Fragments nesting. Recently I had an opportunity to use this &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://chalup.github.io/blog/page/5">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Porcupine Programmer" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-51611487-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Porcupine Programmer</a></h1>
  
    <h2>Programming rants, random stuff and some more programming.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:chalup.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/16/android-nested-fragments-in-practice/">Android Nested Fragments in Practice</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-16T22:03:00+01:00" pubdate data-updated="true">Mar 16<span>th</span>, 2013</time>
        
           | <a href="/blog/2013/03/16/android-nested-fragments-in-practice/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2013/03/16/android-nested-fragments-in-practice/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Last November I wrote about the new feature in rev11 of Android support package &ndash; <a href="/blog/2012/11/13/android-gets-nested-fragments">Fragments nesting</a>. Recently I had an opportunity to use this feature in practice and I&rsquo;d like to share my experience with it.</p>

<p>The basics are simple: each <a href="http://developer.android.com/reference/android/support/v4/app/FragmentActivity.html"><code>FragmentActivity</code></a> and each <a href="http://developer.android.com/reference/android/support/v4/app/Fragment.html"><code>Fragment</code></a> has it&rsquo;s own <a href="http://developer.android.com/reference/android/support/v4/app/FragmentManager.html"><code>FragmentManager</code></a>. Inside the Fragment you may call <a href="http://developer.android.com/reference/android/support/v4/app/Fragment.html#getFragmentManager%28%29"><code>getFragmentManager()</code></a> to get the <code>FragmentManager</code> this <code>Fragment</code> was added to, or <a href="http://developer.android.com/reference/android/support/v4/app/Fragment.html#getChildFragmentManager%28%29"><code>getChildFragmentManager()</code></a> to get the <code>FragmentManager</code> which can be used to nest <code>Fragments</code> inside this <code>Fragment</code>. This basic flow works fine, but I have found two issues.</p>

<p>If you have a <code>Fragment</code> with nested <code>Fragments</code> and you save its state with <a href="http://developer.android.com/reference/android/support/v4/app/FragmentManager.html#saveFragmentInstanceState%28android.support.v4.app.Fragment%29"><code>saveFragmentInstanceState()</code></a> and try to use it in <a href="http://developer.android.com/reference/android/support/v4/app/Fragment.html#setInitialSavedState%28android.support.v4.app.Fragment.SavedState%29"><code>setInitialSavedState()</code></a> on another instance of this <code>Fragment</code>, you&rsquo;ll get the <code>BadParcelableException</code> from <code>onCreate</code>. Fortunately it&rsquo;s an obvious bug which is easy to fix: you just need to set the correct <code>ClassLoader</code> for a <code>Bundle</code> containing this <code>Fragment</code>&rsquo;s state. There is a <a href="https://android-review.googlesource.com/#/c/40760/">patch for it in support library project Gerrit</a>, and if you need this fix ASAP you may use <a href="https://github.com/futuresimple/android-support-v4">this fork of support lib on Github</a>.</p>

<p>The second issue is related with the <code>Fragments</code> backstack. Inside each <code>FragmentManager</code> you may build stack of <code>Fragments</code> with <a href="http://developer.android.com/reference/android/support/v4/app/FragmentTransaction.html#addToBackStack%28java.lang.String%29"><code>FragmentTransaction.addToBackStack()</code></a> and later on use <a href="http://developer.android.com/reference/android/support/v4/app/FragmentManager.html#popBackStack%28%29"><code>popBackStack()</code></a> to go back to the previous state. Pressing hardware back key is also supposed to pop the <code>Fragments</code> from the back stack, but it doesn&rsquo;t take into account any nested <code>Fragments</code>, only <code>Fragments</code> added to the <code>Activity</code>&rsquo;s <code>FragmentManager</code>. This is not so easy to fix, but you may use the following workaround:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">FAKE_BACKSTACK_ENTRY</span> <span class="o">=</span> <span class="s">&quot;fakeBackstackEntry&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">getFragmentManager</span><span class="o">()</span>
</span><span class='line'>    <span class="o">.</span><span class="na">beginTransaction</span><span class="o">()</span>
</span><span class='line'>    <span class="o">.</span><span class="na">addToBackStack</span><span class="o">(</span><span class="kc">null</span><span class="o">)</span>
</span><span class='line'>    <span class="c1">// call replace/add</span>
</span><span class='line'>    <span class="o">.</span><span class="na">setTransition</span><span class="o">(</span><span class="n">FragmentTransaction</span><span class="o">.</span><span class="na">TRANSIT_FRAGMENT_OPEN</span><span class="o">)</span>
</span><span class='line'>    <span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="kd">final</span> <span class="n">FragmentManager</span> <span class="n">rootFragmentManager</span> <span class="o">=</span> <span class="n">getActivity</span><span class="o">().</span><span class="na">getSupportFragmentManager</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="n">rootFragmentManager</span>
</span><span class='line'>    <span class="o">.</span><span class="na">beginTransaction</span><span class="o">()</span>
</span><span class='line'>    <span class="o">.</span><span class="na">addToBackStack</span><span class="o">(</span><span class="kc">null</span><span class="o">)</span>
</span><span class='line'>    <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Fragment</span><span class="o">(),</span> <span class="n">FAKE_BACKSTACK_ENTRY</span><span class="o">)</span>
</span><span class='line'>    <span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="n">rootFragmentManager</span><span class="o">.</span><span class="na">addOnBackStackChangedListener</span><span class="o">(</span><span class="k">new</span> <span class="n">OnBackStackChangedListener</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onBackStackChanged</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">rootFragmentManager</span><span class="o">.</span><span class="na">findFragmentByTag</span><span class="o">(</span><span class="n">FAKE_BACKSTACK_ENTRY</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">getFragmentManager</span><span class="o">().</span><span class="na">popBackStack</span><span class="o">();</span>
</span><span class='line'>      <span class="n">rootFragmentManager</span><span class="o">.</span><span class="na">removeOnBackStackChangedListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Quick explanation: together with the actual backstack entry we want to add, we also add the fake backstack entry with empty <code>Fragment</code> to top level <code>FragmentManager</code> and set up <a href="http://developer.android.com/reference/android/support/v4/app/FragmentManager.OnBackStackChangedListener.html"><code>OnBackStackChangedListener</code></a>. When user presses hardware back button, the fake backstack entry is popped, the backstack listener is triggered and our implementation pops the backstack inside our <code>Fragment</code>. The backstack listeners are not persisted throughout the orientation change, so we need to setup it again inside <code>onCreate()</code>.</p>

<p>Note that there are two issues with this workaround: it allows adding only one backstack entry and this setup won&rsquo;t be automatically recreated from state saved by <code>saveFragmentInstanceState()</code> (fortunately it does work with orientation change). Both issues probably can be solved by some additional hacks, but writing workarounds for workarounds is not something I do unless I really have to, and in this case I neither issue affected me.</p>

<p>Besides those bumps the nested <code>Fragments</code> are a real blessing which allows much more cleaner and reusable code.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/05/weekend-hack-viewing-markdown/">Weekend Hack: Viewing Markdown Attachments in GMail on Android</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-05T23:02:00+01:00" pubdate data-updated="true">Mar 5<span>th</span>, 2013</time>
        
           | <a href="/blog/2013/03/05/weekend-hack-viewing-markdown/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2013/03/05/weekend-hack-viewing-markdown/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I wanted to open a markdown email attachment on my Nexus 4, but after clicking &ldquo;readme.md&rdquo; instead of seeing the file contents I saw this message:</p>

<p><img class="center" src="/images/no_app_dialog.png"></p>

<p>I downloaded few apps from Google Play, but the message was still appearing. The same applications could open a local markdown file, so I went back to GMail app to download the attachment, but another unpleasant surprise awaited me:</p>

<p><img class="center" src="/images/no_overflow.png"></p>

<p>There is no &ldquo;overflow&rdquo; menu on the attachment (see the screenshot below), which means I couldn&rsquo;t access the &ldquo;Save&rdquo; option, so I could open it as a local file.</p>

<p><img class="center" src="/images/save_menu.png"></p>

<p>At this point I was:</p>

<ol>
<li>Pissed off, because, cmon, GMail is probably the most used app working on the mature operating system and I can&rsquo;t download a fucking file with it.</li>
<li>Curious, because it looked liked an interesting issue with GMail app.</li>
</ol>


<p>The first clue was in the GMail logs in the logcat:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>03-04 21:12:50.477: W/Gmail(13823): Unable to find supporting activity. mime-type: application/octet-stream, uri: content://gmail-ls/jerzy.chalupski@gmail.com/messages/121/attachments/0.1/BEST/false, normalized mime-type: application/octet-stream normalized uri: content://gmail-ls/jerzy.chalupski@gmail.com/messages/121/attachments/0.1/BEST/false</span></code></pre></td></tr></table></div></figure>


<p>Note the Uri: there is no file name and no file extension, and the mime-type is a generic application/octet-stream (most likely because the &ldquo;md&rdquo; extension is not present in <a href="http://grepcode.com/file/repo1.maven.org/maven2/com.google.okhttp/okhttp/20120626/libcore/net/MimeUtils.java">libcore.net.MimeUtils</a>). The markdown viewers/editors I downloaded probably register intent filters for specific file extensions, so they don&rsquo;t know they could handle this file. It sucks big time, because it means that the applications for viewing files with non-standard extensions would have to register for application/octet-stream mime-type, and even though they handle very specific file types they all appear in the app chooser dialog for many different file types, which defeats the whole purpose of Android Intent system and reduces the UX.</p>

<p>My first idea was to create an &ldquo;GMail Attachment Forwarder&rdquo; app which registers for any content from GMail, gets the attachment mail by querying the <a href="http://developer.android.com/reference/android/provider/MediaStore.MediaColumns.html#DISPLAY_NAME"><code>DISPLAY_NAME</code></a> column on the Uri supplied by GMail, save this information along with original GMail Uri in public <a href="http://developer.android.com/reference/android/content/ContentProvider.html"><code>ContentProvider</code></a>, and start the activity using Uri exposed by my <a href="http://developer.android.com/reference/android/content/ContentProvider.html"><code>ContentProvider</code></a> which does contain attachment name. This <a href="http://developer.android.com/reference/android/content/ContentProvider.html"><code>ContentProvider</code></a> should also forward any action to original GMail Uri.</p>

<p>Unfortunatly I was foiled by the <a href="http://developer.android.com/reference/android/content/ContentProvider.html"><code>ContentProvider</code></a>&rsquo;s permissions systems: the Activity in my app was temporarily granted with the read permissions for GMail&rsquo;s <a href="http://developer.android.com/reference/android/content/ContentProvider.html"><code>ContentProvider</code></a>, but this permissions did not extend to my <a href="http://developer.android.com/reference/android/content/ContentProvider.html"><code>ContentProvider</code></a> and the app I was forwarding the attachment to failed because of the insufficient permissions.</p>

<p>This approach didn&rsquo;t work, but having a catch-all handler for GMail attachments unlocked the attachment actions. I also noticed that when the attachment is downloaded, the GMail uses a slightly different intent:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>03-04 23:05:34.005: I/ActivityManager(526): START u0 {act=android.intent.action.VIEW dat=file:///storage/emulated/0/Download/readme-1.md typ=application/octet-stream flg=0x80001 cmp=com.chalup.markdownviewer/.MainActivity} from pid 3063</span></code></pre></td></tr></table></div></figure>


<p>This led me to plan B: have an app which enables the attachment download and use other apps to open downloaded attachments. I renamed my app to GMail Attachment Unlocker, cleared the manifest and source folder leaving only a single, automatically closing activity:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;application</span>
</span><span class='line'>  <span class="na">android:allowBackup=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>  <span class="na">android:label=</span><span class="s">&quot;@string/app_name&quot;</span>
</span><span class='line'>  <span class="na">android:theme=</span><span class="s">&quot;@android:style/Theme.NoDisplay&quot;</span> <span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;activity</span>
</span><span class='line'>    <span class="na">android:name=</span><span class="s">&quot;com.chalup.gmailattachmentunlocker.MainActivity&quot;</span>
</span><span class='line'>    <span class="na">android:label=</span><span class="s">&quot;@string/app_name&quot;</span> <span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;intent-filter&gt;</span>
</span><span class='line'>      <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.action.VIEW&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.category.DEFAULT&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.category.BROWSABLE&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nt">&lt;data</span>
</span><span class='line'>        <span class="na">android:host=</span><span class="s">&quot;gmail-ls&quot;</span>
</span><span class='line'>        <span class="na">android:mimeType=</span><span class="s">&quot;*/*&quot;</span>
</span><span class='line'>        <span class="na">android:scheme=</span><span class="s">&quot;content&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/intent-filter&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/activity&gt;</span>
</span><span class='line'><span class="nt">&lt;/application&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>    <span class="n">finish</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The full source code is <a href="https://github.com/chalup/gmail-attachment-unlocker">available on my Github</a> (althought there really isn&rsquo;t much more than what is posted here). In the end I also ended up writing my own markdown viewer (source code in <a href="https://github.com/chalup/android-markdown-viewer">another repo on my Github</a>), because none of the apps I have downloaded properly rendered tags (hint: you have to use <a href="http://developer.android.com/reference/android/webkit/WebView.html#loadDataWithBaseURL%28java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String%29"><code>WebView.loadDataWithBaseUrl</code></a> instead of <a href="http://developer.android.com/reference/android/webkit/WebView.html#loadData%28java.lang.String,%20java.lang.String,%20java.lang.String%29"><code>WebView.loadData</code></a>).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/20/guava-on-android/">Guava on Android</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-20T22:15:00+01:00" pubdate data-updated="true">Feb 20<span>th</span>, 2013</time>
        
           | <a href="/blog/2013/02/20/guava-on-android/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2013/02/20/guava-on-android/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In November 2012, the revision 21 of Android SDK Tools was released and one of the items in the <a href="http://developer.android.com/tools/sdk/tools-notes.html">release notes</a> made me a very happy panda:</p>

<blockquote><p>Improved the build time by pre-dexing libraries (both JAR files and library projects).</p></blockquote>


<p>This change solved the most problematic issue with <a href="http://code.google.com/p/guava-libraries/">Guava</a> and other large libraries &ndash; build time. Before this change Android tools executed dex for your code and every referenced library every time you wanted to launch the application, which in case of Guava took ages and required increasing heap space for Java VM, because the Eclipse closed with &ldquo;Unable to execute dex: Java heap space&rdquo; error.</p>

<p>IntelliJ users could work around this issue by enabling Proguard for debug builds, which could reduce the size of dex input by removing unused code. Eclipse users might try generalizing the <a href="http://code.google.com/p/treeshaker/">Treeshaker plugin</a>, which does pretty much the same inside a custom compilation step added before dexing. But there was no straight way to use Guava and keep the build times on the sane level.</p>

<p>Now the first build still takes ages, and the Eclipse still crashes if you don&rsquo;t bump its heap space, but for all consecutive builds everything works blazing fast. Goodbye hand rolled stuff, welcome <a href="http://code.google.com/p/guava-libraries/wiki/ImmutableCollectionsExplained">immutable collections</a>, <a href="http://code.google.com/p/guava-libraries/wiki/OrderingExplained">fluent comparators</a>, <a href="http://code.google.com/p/guava-libraries/wiki/CommonObjectUtilitiesExplained#hashCode">hashCode helper</a> and tons of <a href="http://code.google.com/p/guava-libraries/wiki/GuavaExplained">other goodness</a>. I keep finding in our code base whole chunks of code which can be replaced with one or two lines utilizing Guava features. I plan to post a summary of those changes.</p>

<p>Final note: if you are using Proguard, remember to add Guava specific entries <a href="http://code.google.com/p/guava-libraries/wiki/UsingProGuardWithGuava">mentioned in the documentation</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/30/android-sync-adapter-lifecycle/">Android: Sync Adapter Lifecycle</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-30T21:46:00+01:00" pubdate data-updated="true">Jan 30<span>th</span>, 2013</time>
        
           | <a href="/blog/2013/01/30/android-sync-adapter-lifecycle/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2013/01/30/android-sync-adapter-lifecycle/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In <a href="/blog/2012/09/26/android-sticky-broadcast-perils">Android sticky broadcast perils</a> I hinted that the <a href="http://developer.android.com/reference/android/content/ContentResolver.html#isSyncActive%28android.accounts.Account,%20java.lang.String%29"><code>ContentResolver.isSyncActive()</code></a> might not yield the results you&rsquo;d expect. I described this issue in <a href="/blog/2012/12/18/krakdroid-aftermath">the talk I gave during the KrakDroid 2012 conference</a>, but the chances are you weren&rsquo;t there, so I decided to write a blog post about it.</p>

<p><a href="http://developer.android.com/reference/android/content/ContentResolver.html"><code>ContentResolver</code></a> contains bunch of static methods with &ldquo;sync&rdquo; in their name: there is <a href="http://developer.android.com/reference/android/content/ContentResolver.html#requestSync%28android.accounts.Account,%20java.lang.String,%20android.os.Bundle%29"><code>requestSync</code></a> to start sync process, <a href="http://developer.android.com/reference/android/content/ContentResolver.html#isSyncPending%28android.accounts.Account,%20java.lang.String%29"><code>isSyncPending</code></a> and <a href="http://developer.android.com/reference/android/content/ContentResolver.html#isSyncActive%28android.accounts.Account,%20java.lang.String%29"><code>isSyncActive</code></a> for polling the sync state, <a href="http://developer.android.com/reference/android/content/ContentResolver.html#addStatusChangeListener%28int,%20android.content.SyncStatusObserver%29"><code>addStatusChangeListener</code></a> for listening for sync status and finally <a href="http://developer.android.com/reference/android/content/ContentResolver.html#cancelSync%28android.accounts.Account,%20java.lang.String%29"><code>cancelSync</code></a> for stopping the ongoing synchronization process. The list looks fine, in a sense that theoretically it&rsquo;s enough to implement the most sync-related functionality on the UI side. Let&rsquo;s see what is the relation between sync status reported by ContentResolver&rsquo;s sync methods and <a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html#onPerformSync%28android.accounts.Account,%20android.os.Bundle,%20java.lang.String,%20android.content.ContentProviderClient,%20android.content.SyncResult%29"><code>onPerformSync</code></a> method in your <a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html"><code>SyncAdapter</code></a>.</p>

<p>After calling <a href="http://developer.android.com/reference/android/content/ContentResolver.html#requestSync%28android.accounts.Account,%20java.lang.String,%20android.os.Bundle%29"><code>requestSync</code></a>, the sync for a given account and authority is added to the pending list, meaning that the sync will be executed as soon as possible (for example when syncs for other authorities are finished). In this state the <a href="http://developer.android.com/reference/android/content/ContentResolver.html#isSyncPending%28android.accounts.Account,%20java.lang.String%29"><code>isSyncPending</code></a> returns true, the <a href="http://developer.android.com/reference/android/content/SyncStatusObserver.html"><code>SyncStatusObservers</code></a> registered with <a href="http://developer.android.com/reference/android/content/ContentResolver.html#SYNC_OBSERVER_TYPE_PENDING"><code>SYNC_OBSERVER_TYPE_PENDING</code></a> mask will be triggered, and so on. This happens <strong>before</strong> your <a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html#onPerformSync%28android.accounts.Account,%20android.os.Bundle,%20java.lang.String,%20android.content.ContentProviderClient,%20android.content.SyncResult%29"><code>onPerformSync</code></a> code is executed. Nothing especially surprising yet. The key point here is, you should take into consideration that your sync request might spend a lot of time in this state, especially if many other SyncAdapters are registered in the system. For example, it&rsquo;s a good idea to indicate this state somehow in the UI, otherwise your app might seem unresponsive.</p>

<p><img class="center" src="/images/sync.png"></p>

<p>When there are no other pending or active sync requests, your sync operation will move to active state. The <code>onPerformSync</code> will start executing in the background thread, <a href="http://developer.android.com/reference/android/content/SyncStatusObserver.html"><code>SyncStatusObservers</code></a> will trigger for both <a href="http://developer.android.com/reference/android/content/ContentResolver.html#SYNC_OBSERVER_TYPE_ACTIVE"><code>SYNC_OBSERVER_TYPE_ACTIVE</code></a> (because the sync request enters this state) and <a href="http://developer.android.com/reference/android/content/ContentResolver.html#SYNC_OBSERVER_TYPE_PENDING"><code>SYNC_OBSERVER_TYPE_PENDING</code></a> (because the sync request leaves this state) masks, <a href="http://developer.android.com/reference/android/content/ContentResolver.html#isSyncPending%28android.accounts.Account,%20java.lang.String%29"><code>isSyncPending</code></a> will return false, and <a href="http://developer.android.com/reference/android/content/ContentResolver.html#isSyncActive%28android.accounts.Account,%20java.lang.String%29"><code>isSyncActive</code></a> will return true. In the happy case, when the <a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html#onPerformSync%28android.accounts.Account,%20android.os.Bundle,%20java.lang.String,%20android.content.ContentProviderClient,%20android.content.SyncResult%29"><code>onPerformSync</code></a> method will finish normally, the <a href="http://developer.android.com/reference/android/content/SyncStatusObserver.html"><code>SyncStatusObservers</code></a> for <a href="http://developer.android.com/reference/android/content/ContentResolver.html#SYNC_OBSERVER_TYPE_ACTIVE"><code>SYNC_OBSERVER_TYPE_ACTIVE</code></a> state will trigger again, and <a href="http://developer.android.com/reference/android/content/ContentResolver.html#isSyncActive%28android.accounts.Account,%20java.lang.String%29"><code>isSyncActive</code></a> will return false again. Booring.</p>

<p>The things get funny when the cancelSync is called during <a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html#onPerformSync%28android.accounts.Account,%20android.os.Bundle,%20java.lang.String,%20android.content.ContentProviderClient,%20android.content.SyncResult%29"><code>onPerformSync</code></a> execution. The sync thread will be interrupted and the <a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html#onSyncCanceled%28%29"><code>onSyncCancelled</code></a> method in <code>SyncAdapter</code> will be called. The <a href="http://developer.android.com/reference/android/content/SyncStatusObserver.html"><code>SyncStatusObservers</code></a> will trigger, <a href="http://developer.android.com/reference/android/content/ContentResolver.html#isSyncActive%28android.accounts.Account,%20java.lang.String%29"><code>isSyncActive</code></a> will return false and so on, and&hellip; at some point the <a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html#onPerformSync%28android.accounts.Account,%20android.os.Bundle,%20java.lang.String,%20android.content.ContentProviderClient,%20android.content.SyncResult%29"><code>onPerformSync</code></a> method will finish execution.</p>

<p>Say what? Wasn&rsquo;t the sync thread interrupted? It was, but not in a &ldquo;Bang, you&rsquo;re dead&rdquo; way, but in a <a href="http://www.drdobbs.com/parallel/interrupt-politely/207100682">&ldquo;polite&rdquo; way as described by Herb Sutter</a>. All the stuff described in the <a href="http://developer.android.com/reference/java/lang/Thread.html#interrupt%28%29"><code>Thread.interrupt</code></a> happened, but in 99% of cases it means that the thread continues to execute as usual, except the <a href="http://developer.android.com/reference/java/lang/Thread.html#isInterrupted%28%29"><code>interrupted</code></a> flag is now set. To really support cancelling the sync thread you&rsquo;d have to define an interruption points at which you&rsquo;ll check this flag and return early from <a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html#onPerformSync%28android.accounts.Account,%20android.os.Bundle,%20java.lang.String,%20android.content.ContentProviderClient,%20android.content.SyncResult%29"><code>onPerformSync</code></a>.</p>

<p><a href="http://twimgs.com/ddj/images/article/2008/0804/080401hs01_f1.gif"><img class="center" src="http://twimgs.com/ddj/images/article/2008/0804/080401hs01_f1.gif"></a>
Things get even funnier here: when I used the <a href="http://developer.android.com/reference/java/lang/Thread.html#isInterrupted%28%29"><code>isInterrupted</code></a> method for polling the state of the sync thread, I got the bad case of heisenbug. In 9 cases out of 10 everything worked as expected, but every now and then the thread continued to execute even though earlier the <a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html#onSyncCanceled%28%29"><code>onSyncCancelled</code></a> was called. I guess somewhere else the <code>InterruptedException</code> was caught and never rethrown or someone else was polling the sync thread with <a href="http://developer.android.com/reference/java/lang/Thread.html#interrupted%28%29"><code>interrupted</code></a> and cleared the flag. To pinpoint the root cause of this behavior I&rsquo;d have to read through a lot of code, so instead I implemented my own flag and set it in <a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html#onSyncCanceled%28%29"><code>onSyncCancelled</code></a> callback. Works like a charm.</p>

<p>Why is this an issue though? Can&rsquo;t we just let <a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html#onPerformSync%28android.accounts.Account,%20android.os.Bundle,%20java.lang.String,%20android.content.ContentProviderClient,%20android.content.SyncResult%29"><code>onPerformSync</code></a> to finish in some undefined future? In most cases that&rsquo;s exactly the right way to think about this issue, but if the <a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html#onPerformSync%28android.accounts.Account,%20android.os.Bundle,%20java.lang.String,%20android.content.ContentProviderClient,%20android.content.SyncResult%29"><code>onPerformSync</code></a> holds a lock on some resource like database handle, you might need to ensure that this lock is released as soon as possible after user cancels the sync.</p>

<p><strong>Recap</strong>: show the sync pending state in the UI and if you really have to know when the sync has ended, do not trust the <code>ContentResolver</code> sync methods.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/12/30/2012-summary/">2012 Summary</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-30T22:39:00+01:00" pubdate data-updated="true">Dec 30<span>th</span>, 2012</time>
        
           | <a href="/blog/2012/12/30/2012-summary/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/12/30/2012-summary/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The end of the year is the usual time for looking back and making a new years&#8217; resolutions, so I&rsquo;m going to gloat a little bit and do some wishful thinking about the next year. Without further ado, let me list what I&rsquo;ve managed to accomplish:</p>

<ol>
<li>I have <a href="http://store.ovi.com/content/219800">published</a> <a href="http://store.ovi.com/content/262535">three</a> <a href="http://store.ovi.com/content/318428">apps</a> on two <a href="https://play.google.com/store/apps/developer?id=chalup">mobile</a> <a href="http://store.ovi.com/publisher/Jerzy%20Chalupski/">platforms</a>.</li>
<li>I changed my safe corporate job for a position in the <a href="https://getbase.com/">startup</a>.</li>
<li>I <a href="http://www.krakdroid.pl/#speaker_8">gave a talk at the conference</a>.</li>
<li>There were over 4k unique visits of my blog and got a couple of +1s.</li>
</ol>


<p>And what are my plans for the next year? I like to keep things simple, so let&rsquo;s just double the values from the list above, except maybe for the second point &ndash; I hope I won&rsquo;t have to change the job, I&rsquo;m very happy with my current employer.</p>

<p>Anyways, thanks for reading my blog and stay tuned for more content next year!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/12/28/unknownhostexception-gotcha/">UnknownHostException Gotcha</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-28T11:28:00+01:00" pubdate data-updated="true">Dec 28<span>th</span>, 2012</time>
        
           | <a href="/blog/2012/12/28/unknownhostexception-gotcha/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/12/28/unknownhostexception-gotcha/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Several days ago I was preparing a simple app for the programming contest organized by <a href="https://getbase.com/">Future Simple</a> during <a href="http://www.krakdroid.pl/">KrakDroid</a> conference. It consisted of a public <a href="http://developer.android.com/reference/android/content/ContentProvider.html"><code>ContentProvider</code></a>, <a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html"><code>SyncAdapter</code></a> and an <a href="http://developer.android.com/reference/android/app/Activity.html"><code>Activity</code></a>. The contest participants had to write an app which retrieves the input data from <a href="http://developer.android.com/reference/android/content/ContentProvider.html"><code>ContentProvider</code></a>, solve a very simple algorithmic problem and save the output back in the <a href="http://developer.android.com/reference/android/content/ContentProvider.html"><code>ContentProvider</code></a>. This would trigger the sync and the <a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html"><code>SyncAdapter</code></a> would upload the data to our backend. The <a href="http://developer.android.com/reference/android/app/Activity.html"><code>Activity</code></a> showed the contest rules and the list of submissions.</p>

<p>As you can see it&rsquo;s nothing fancy and I hacked everything together rather quickly, but when I tried to send the first submission I got the <a href="http://developer.android.com/reference/java/net/UnknownHostException.html"><code>UnknownHostException</code></a> from <a href="http://developer.android.com/reference/org/apache/http/impl/client/AbstractHttpClient.html#execute%28org.apache.http.client.methods.HttpUriRequest%29"><code>AbstractHttpClient.execute()</code></a>. Had I <a href="https://www.google.pl/search?q=android+UnknownHostException">googled</a> the issue first, I&rsquo;d solve this issue in one minute. The problem is, my internet connection was flaky and the backend I tried to connect to was set up couple hours earlier, so the <a href="http://developer.android.com/reference/java/net/UnknownHostException.html"><code>UnknownHostException</code></a> seemed like a quite probable error.</p>

<p>If you haven&rsquo;t click the Google link above, here&rsquo;s the solution: this exception is a way in which Android tells you that your app is missing the <a href="http://developer.android.com/reference/android/Manifest.permission.html#INTERNET">INTERNET</a> permission.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/12/18/krakdroid-aftermath/">KrakDroid Aftermath</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-18T09:03:00+01:00" pubdate data-updated="true">Dec 18<span>th</span>, 2012</time>
        
           | <a href="/blog/2012/12/18/krakdroid-aftermath/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/12/18/krakdroid-aftermath/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I finally got some sleep after a really busy weekend. For the first time I had an opportunity to give a talk at the programming related conference. I was also responsible for a programming contest organized by the company I work at, I tried to push the new release of our product and, on top of that, I had to do some Christmas related stuff, so I didn&rsquo;t get much sleep.</p>

<p>Let&rsquo;s get back to the programming. I gave the talk about standard synchronization pattern on Android (<code>SyncAdapter</code> + <code>Authenticator</code> + <code>ContentProvider</code>) during this year&rsquo;s edition of KrakDroid conference. Here are the slides:</p>

<iframe allowfullscreen="" frameborder="0" height="356" marginheight="0" marginwidth="0" mozallowfullscreen="" scrolling="no" src="http://www.slideshare.net/slideshow/embed_code/15668008" style="border-width: 1px 1px 0; border: 1px solid #CCC; margin-bottom: 5px;" webkitallowfullscreen="" width="427"> </iframe>


<p>
<strong> <a href="http://www.slideshare.net/chalup/sync-on-android">Sync on Android</a> </strong> from <strong><a href="http://www.slideshare.net/chalup">chalup</a></strong></p>

<p>The link to recorded video can be found in the slideshare content description. I won&rsquo;t bother posting it here, because a) I gave the talk in Polish, and I try to keep the content of this blog in English b) I was really tired, at one point of the talk I had to stop and ask myself &ldquo;What the hell am I trying to say&rdquo;.</p>

<p>Although my talk was average and there are many things I might have done better, I&rsquo;m very happy I had an opportunity to give this talk. Public speaking is definitely outside of my comfort zone and I learned a lot. Here&rsquo;s the &ldquo;conference speaker checklist&rdquo; for my future self:</p>

<ol>
<li>Get some sleep</li>
<li><p>Do the test run of the talk in front of the mirror</p>

<p> I finished the slides for my presentation half an hour before giving it, so I didn&rsquo;t have a chance to rehearse it. There were few points during my talk when adding a slide with a summary would make things much clearer. Which brings me to the next point:</p></li>
<li><p>Recap</p>

<p> I&rsquo;m not sure how much the listeners who didn&rsquo;t knew anything about sync will remember from my talk. The recaps could help them remember at least some keywords they would be able to google later.</p></li>
<li><p>Do the test run of the talk in front of other people</p>

<p> But not any other people &ndash; you want your audience to be critical and at least a bit familiar with the topic. You want someone who will tell you that this part of the talk is boring or that part is not clear.</p></li>
<li><p>Get more sleep</p></li>
</ol>


<p>And finally, do not freak out &ndash; the hardest part is saying &ldquo;Hello, my name is&hellip;&rdquo;, the rest will pour out of you.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/13/android-gets-nested-fragments/">Android Gets Nested Fragments</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-13T21:31:00+01:00" pubdate data-updated="true">Nov 13<span>th</span>, 2012</time>
        
           | <a href="/blog/2012/11/13/android-gets-nested-fragments/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/11/13/android-gets-nested-fragments/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Most of the items in the <a href="http://developer.android.com/about/versions/android-4.2.html">Android 4.2 APIs list</a> are kind of &ldquo;meh&rdquo; to me, but there is one item that&rsquo;s make me very happy: <a href="http://developer.android.com/about/versions/android-4.2.html#NestedFragments">nested fragments</a>. Fragments were supposed to be reusable UI components, but for some unfathomable reason the initial release of the fragments API didn&rsquo;t allow composing a fragment from other fragments. Even during the 2012 Google I/O one of the Google developers said that they have discussed this idea, but they&rsquo;re not sure if it&rsquo;s a good one, which is an absolute surprise to me, because I don&rsquo;t think anyone sane would consider making the <a href="http://developer.android.com/reference/android/view/ViewGroup.html"><code>ViewGroup</code></a> which isn&rsquo;t a subclass of a <a href="http://developer.android.com/reference/android/view/View.html"><code>View</code></a>.</p>

<p>Fragment nesting was a topic I kept on my topic list for a day when I feel I need to bitch about something, but now I&rsquo;m happy to remove it and write this ecstatic post. So now launch your SDK managers and download the r11 of support package! (or wait for half a year and hope it will be added to <a href="http://search.maven.org/#search%7Cgav%7C1%7Cg%3A%22com.google.android%22%20AND%20a%3A%22support-v4%22">Maven Central</a>)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/17/android-protip-remove-debug-logs-from/">Android Protip: Remove Debug Logs From Release Builds With Proguard</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-17T22:59:00+02:00" pubdate data-updated="true">Oct 17<span>th</span>, 2012</time>
        
           | <a href="/blog/2012/10/17/android-protip-remove-debug-logs-from/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/10/17/android-protip-remove-debug-logs-from/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I use the <code>android.util.Log</code> extensively &ndash; often it&rsquo;s faster than starting the debugger and (unlike debugging) it&rsquo;s always on, which is invaluable when you&rsquo;re trying to track the root cause of some hard to reproduce bugs. Logging is also nice for release candidate builds you give to the QA team &ndash; if they find some bugs you&rsquo;ll have more information than just a stack trace.</p>

<p>On the other hand you don&rsquo;t want to keep all those logs for release builds, mostly for performance and privacy reasons. If you google around for a solution to this issue you&rsquo;ll probably find a dozen ideas like using a wrapper for logging class, using a dedicated logging framework or even some sed/awk scripts to ant build process. Among those ideas is the one I&rsquo;d like to recommend: customizing <a href="http://developer.android.com/tools/help/proguard.html">Proguard</a> configuration.</p>

<p>Proguard is automatically run in release builds by ant and Export wizards from Eclipse and there is an <a href="http://proguard.sourceforge.net/index.html#manual/usage.html">optimization option</a>, which can be used to disable logs:</p>

<blockquote><p>-assumenosideeffects</p><p>Specifies methods that don&#8217;t have any side effects (other than maybe returning a value). In the optimization step, ProGuard will then remove calls to such methods, if it can determine that the return values aren&#8217;t used.</p></blockquote>


<p>I wouldn&rsquo;t use this tool for the purpose stated in the manual, because even if my code doesn&rsquo;t have any side effects, the methods called from it might have ones; I&rsquo;d rather use some static code analysis tool to find the unnecessary calls and manually remove them. It looks perfect for suppressing the logs though and it&rsquo;s very simple to set up &ndash; just add the following lines to the proguard-project.txt file generated by <a href="http://developer.android.com/tools/help/android.html">android command line tool</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-assumenosideeffects class android.util.Log {
</span><span class='line'>    public static *** d(...);
</span><span class='line'>    public static *** v(...);
</span><span class='line'>    public static *** i(...);
</span><span class='line'>    public static *** w(...);
</span><span class='line'>    public static *** e(...);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>You can of course keep some of the priority levels by removing lines from this config.</p>

<p>The nice thing about this solution is that you have to set it only once and it will just work for all further release builds.</p>

<p><strong>UPDATE (August 2013):</strong> do not assume that Proguard will remove any code other than the methods listed in assumenosideeffects setting. See <a href="/blog/2013/08/20/proguard-gotcha">&ldquo;Proguard gotcha&rdquo;</a> post for more details.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/09/android-font-metrics-for-dummies/">Android Font Metrics for Dummies</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-09T22:59:00+02:00" pubdate data-updated="true">Oct 9<span>th</span>, 2012</time>
        
           | <a href="/blog/2012/10/09/android-font-metrics-for-dummies/#disqus_thread"
             data-disqus-identifier="http://chalup.github.io/blog/2012/10/09/android-font-metrics-for-dummies/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I was working on a custom View with overridden <a href="http://developer.android.com/reference/android/view/View.html#onDraw%28android.graphics.Canvas%29"><code>onDraw()</code></a> method and at some point I needed to center some text vertically. Unfortunately <a href="http://developer.android.com/reference/android/graphics/Paint.html#setTextAlign%28android.graphics.Paint.Align%29"><code>Paint.setTextAlign()</code></a> supports only horizontal orientation, so I tried calculating the y-coordinate of the origin myself, but I couldn&rsquo;t get it exactly right. After two failed attempts I decided that I need a program which visualizes the available font metrics, because it seems that I do not understand the <a href="http://developer.android.com/reference/android/graphics/Paint.FontMetrics.html"><code>FontMetrics</code></a> documentation, or the aforementioned class and it&rsquo;s documentation sucks.</p>

<p>You can find the <a href="https://github.com/chalup/android-fontmetricstest">source code on my GitHub</a>, and here&rsquo;s the screenshot for other typographically challenged programmers:</p>

<p><img class="center" src="/images/fontsfordummies.png"></p>

<p>(BTW: the word &ldquo;Żyłę&rdquo; used there is not a complete gibberish, it&rsquo;s an accusative case of word &ldquo;vein&rdquo; in Polish; it&rsquo;s nice, because it&rsquo;s short, but it covers all cases of the metrics class).</p>

<p>Let&rsquo;s get back to vertical alignment. In general you should center text vertically either on <a href="http://en.wikipedia.org/wiki/X-height">x-height</a> or on half the <a href="http://en.wikipedia.org/wiki/Cap_height">cap height</a> above the <a href="http://en.wikipedia.org/wiki/Baseline_%28typography%29">baseline</a> (at least that&rsquo;s the info I found). Neither metric is directly available in <a href="http://developer.android.com/reference/android/graphics/Paint.FontMetrics.html"><code>FontMetrics</code></a> class, but you can approximate the cap height as a <code>textSize - descent</code> or calculate x-height yourself using Rect height returned by <a href="http://developer.android.com/reference/android/graphics/Paint.html#getTextBounds%28java.lang.String,%20int,%20int,%20android.graphics.Rect%29"><code>Paint.getTextBounds</code></a> for string &ldquo;x&rdquo;.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/6/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/4/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/06/15/minsdkversion-equals-15/">minSdkVersion=15, What&#8217;s Next?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/13/beatiful-code-comparisonchain-from-guava/">Beatiful Code: ComparisonChain</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/12/android-loaders/">Android Loaders</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/10/enabling-proguard-for-debug-builds/">ProGuard in Ant Debug Builds</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/22/clicking-unclickable-list-items/">Clicking Unclickable List Items</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/chalup">@chalup</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'chalup',
            count: 0,
            skip_forks: true,
            filter_repos: [ "microorm", "thneed", "dawggenerator", "cerberus" ],
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/106340839330487061995?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Jerzy Chalupski -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'porcupineprogrammer';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
